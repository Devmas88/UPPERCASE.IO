global.MULTI_PROTOCOL_SOCKET_SERVER=MULTI_PROTOCOL_SOCKET_SERVER=CLASS({init:function(e,E,S,t){"use strict";var r,R,o=S.socketServerPort,_=S.webSocketServerPort,i=S.isCreateWebSocketFixRequestManager,O=S.webServer;void 0!==o&&SOCKET_SERVER(o,t),(void 0!==_||void 0!==O)&&WEB_SOCKET_SERVER(void 0!==_?_:O,t),i===!0&&(r=WEB_SOCKET_FIX_REQUEST_MANAGER(t)),E.getWebSocketFixRequest=R=function(){return r.request}}});global.WEB_SOCKET_FIX_REQUEST_MANAGER=WEB_SOCKET_FIX_REQUEST_MANAGER=CLASS(function(){"use strict";var _=5,E=2;return{init:function(e,t,o){var n,d={},R={},T=0,a={},C={},i={},N={},S=function(_,E,e,t){void 0===d[_]&&(d[_]={}),void 0===d[_][E]?d[_][E]=e:d[_][E]+=e,t===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__ADD_CONTENT",data:{clientId:_,requestKey:E,content:e}})},c=function(_,E,e){void 0!==d[_]&&delete d[_][E],e===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_CONTENT",data:{clientId:_,requestKey:E}})},I=function(_,E){void 0!==a[_]?a[_](E):r(_,E,!0)},U=function(_,E,e,t){var o=R[_][E];void 0!==o&&EACH(o,function(E){E(e,function(E){void 0!==t&&I(_,{methodName:"__CALLBACK_"+t,data:E})})})},A=function(_){void 0!==i[_]&&(i[_].remove(),delete i[_]),delete a[_]},r=function(_,E,e){void 0===C[_]&&(C[_]=[]),C[_].push(E),e===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__SEND",data:{clientId:_,params:E}})},v=function(_,E){REMOVE({array:C[_],key:0}),0===C[_].length&&delete C[_],E===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_FIRST_WATING_PARAMS",data:_})},s=function(_,E){void 0!==N[_]&&(N[_].remove(),delete N[_]),E===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_LIFE_DELAY",data:_})},O=function(_,E){A(_),void 0!==R[_]&&delete R[_],void 0!==C[_]&&delete C[_],s(_),void 0!==d[_]&&delete d[_],E===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_ALL",data:_})};void 0!==CPU_CLUSTERING.on&&(CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__RUN_METHODS",function(_){var E=_.clientId;void 0!==R[E]&&U(E,_.methodName,_.data,_.sendKey)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_FIRST_WATING_PARAMS",function(_){void 0!==C[_]&&v(_)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__SEND",function(_){var E=_.clientId,e=_.params;void 0!==a[E]?(a[E](e),void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_FIRST_WATING_PARAMS",data:E})):r(E,e)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_LIFE_DELAY",function(_){s(_)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_ALL",function(_){O(_)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__ADD_CONTENT",function(_){S(_.clientId,_.requestKey,_.content)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_CONTENT",function(_){c(_.clientId,_.requestKey)})),t.request=n=function(e,t){var n,r,G,u=e.params,K=u.clientId,L=INTEGER(u.connectionKey),M=INTEGER(u.requestKey),m=u.content,f="true"===u.isEnd,P=t.response,l=t.onDisconnected,F=function(_,E,e){void 0!==R[K]?U(K,_,E,e):void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__RUN_METHODS",data:{clientId:K,methodName:_,data:E,sendKey:e}}),"__DISCONNECTED"===_&&O(K,!0)};void 0===K?(K=RANDOM_STR(40),n=R[K]={},o({ip:e.ip,headers:e.headers},r=function(_,E){var e=n[_];void 0===e&&(e=n[_]=[]),e.push(E)},G=function(_,E){var e=n[_];void 0!==e&&(void 0!==E?REMOVE({array:e,value:E}):delete n[_])},function(_,E){var e="__CALLBACK_"+T;_.sendKey=T,T+=1,I(K,_),void 0!==E&&r(e,function(_){E(_),G(e)})},function(){F("__DISCONNECTED")}),P({contentType:"text/javascript",content:"CONNECT_TO_WEB_SOCKET_SERVER.response('"+encodeURIComponent(STRINGIFY({clientId:K,connectionKey:L,requestKey:M}))+"')"})):f===!0?(RUN(function(){var e,t,o,n,R=void 0===d[K]?void 0:PARSE_STR(d[K][M]);void 0!==R&&(e=R.methodName,t=R.data,o=R.sendKey),void 0!==e?(F(e,t,o),P({contentType:"text/javascript",content:"CONNECT_TO_WEB_SOCKET_SERVER.removeRequestInfo("+M+")"})):void 0!==a[K]?a[K]():(s(K,!0),n=function(){F("__DISCONNECTED")},a[K]=function(_){P({contentType:"text/javascript",content:"CONNECT_TO_WEB_SOCKET_SERVER.response('"+encodeURIComponent(STRINGIFY({connectionKey:L,clientId:K,params:_,requestKey:M}))+"')"}),A(K),N[K]=DELAY(E,n)},l(n),i[K]=DELAY(_,function(){void 0!==a[K]&&a[K]()}),void 0!==C[K]&&(a[K](C[K][0]),v(K,!0)))}),c(K,M,!0)):(S(K,M,m,!0),P({contentType:"text/javascript",content:"CONNECT_TO_WEB_SOCKET_SERVER.request("+M+")"}))},console.log("[UPPERCASE.IO-WEB_SOCKET_FIX_REQUEST_MANAGER] RUNNING WEB SOCKET FIX REQUEST MANAGER...")}}});global.WEB_SOCKET_SERVER=WEB_SOCKET_SERVER=METHOD({run:function(o,e){"use strict";var n,E,r,i=require("ws").Server;CHECK_IS_DATA(o)!==!0?n=o:E=o,r=new i({port:n,server:void 0===E?void 0:E.getNativeHTTPServer()}),r.on("connection",function(o){var n,E,r,i,t=o.upgradeReq.headers,R={},d=0,a=function(o,e,n){var E=R[o];void 0!==E&&EACH(E,function(o){o(e,function(o){void 0!==n&&i({methodName:"__CALLBACK_"+n,data:o})})})};o.on("message",function(o){var e=PARSE_STR(o);void 0!==e&&a(e.methodName,e.data,e.sendKey)}),o.on("close",function(){a("__DISCONNECTED"),R=void 0}),o.on("error",function(o){var e=o.toString();console.log("[UPPERCASE.IO-WEB_SOCEKT_SERVER] ERROR:",e),a("__ERROR",e)}),n=t["x-forwarded-for"],void 0===n&&(n=o.upgradeReq.connection.remoteAddress),e({ip:n,headers:t},E=function(o,e){var n=R[o];void 0===n&&(n=R[o]=[]),n.push(e)},r=function(o,e){var n=R[o];void 0!==n&&(void 0!==e?REMOVE({array:n,value:e}):delete R[o])},i=function(e,n){var i="__CALLBACK_"+d;e.sendKey=d,d+=1;try{o.send(STRINGIFY(e))}catch(t){console.log("[UPPERCASE.IO-WEB_SOCEKT_SERVER] ERROR:",t.toString())}void 0!==n&&E(i,function(o){n(o),r(i)})},function(){o.close()})}),console.log("[UPPERCASE.IO-WEB_SOCKET_SERVER] RUNNING WEB SOCKET SERVER..."+(void 0===n?"":" (PORT:"+n+")"))}});