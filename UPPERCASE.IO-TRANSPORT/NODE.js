global.MULTI_PROTOCOL_SOCKET_SERVER=MULTI_PROTOCOL_SOCKET_SERVER=CLASS({init:function(E,_,e,o){"use strict";var t,n,R=e.socketServerPort,d=e.webSocketServerPort,i=e.isCreateWebSocketFixRequestManager,S=e.webServer;void 0!==R&&SOCKET_SERVER(R,o),(void 0!==d||void 0!==S)&&WEB_SOCKET_SERVER(void 0!==d?d:S,o),i===!0&&(t=WEB_SOCKET_FIX_REQUEST_MANAGER(o)),_.getWebSocketFixRequest=n=function(){return t.request}}}),global.WEB_SOCKET_FIX_REQUEST_MANAGER=WEB_SOCKET_FIX_REQUEST_MANAGER=CLASS(function(){"use strict";var E=5,_=2;return{init:function(e,o,t){var n,R={},d={},i=0,S={},a={},T={},C={},c=function(E,_,e,o){void 0===R[E]&&(R[E]={}),void 0===R[E][_]?R[E][_]=e:R[E][_]+=e,o===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__ADD_CONTENT",data:{clientId:E,requestKey:_,content:e}})},r=function(E,_,e){void 0!==R[E]&&delete R[E][_],e===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_CONTENT",data:{clientId:E,requestKey:_}})},N=function(E,_){void 0!==S[E]?S[E](_):U(E,_,!0)},v=function(E,_,e,o){var t=d[E][_];void 0!==t&&EACH(t,function(_){_(e,function(_){void 0!==o&&N(E,{methodName:"__CALLBACK_"+o,data:_})})})},I=function(E){void 0!==T[E]&&(T[E].remove(),delete T[E]),delete S[E]},U=function(E,_,e){void 0===a[E]&&(a[E]=[]),a[E].push(_),e===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__SEND",data:{clientId:E,params:_}})},s=function(E,_){REMOVE({array:a[E],key:0}),0===a[E].length&&delete a[E],_===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_FIRST_WATING_PARAMS",data:E})},A=function(E,_){void 0!==C[E]&&(C[E].remove(),delete C[E]),_===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_LIFE_DELAY",data:E})},O=function(E,_){I(E),void 0!==d[E]&&delete d[E],void 0!==a[E]&&delete a[E],A(E),void 0!==R[E]&&delete R[E],_===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_ALL",data:E})};void 0!==CPU_CLUSTERING.on&&(CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__RUN_METHODS",function(E){var _=E.clientId;void 0!==d[_]&&v(_,E.methodName,E.data,E.sendKey)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_FIRST_WATING_PARAMS",function(E){void 0!==a[E]&&s(E)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__SEND",function(E){var _=E.clientId,e=E.params;void 0!==S[_]?(S[_](e),void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_FIRST_WATING_PARAMS",data:_})):U(_,e)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_LIFE_DELAY",function(E){A(E)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_ALL",function(E){O(E)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__ADD_CONTENT",function(E){c(E.clientId,E.requestKey,E.content)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_CONTENT",function(E){r(E.clientId,E.requestKey)})),o.request=n=function(e,o){var n,U,u,K=e.params,G=K.clientId,f=INTEGER(K.connectionKey),L=INTEGER(K.requestKey),P=K.content,M="true"===K.isEnd,l=o.response,m=o.onDisconnected,W=function(E,_,e){void 0!==d[G]?v(G,E,_,e):void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__RUN_METHODS",data:{clientId:G,methodName:E,data:_,sendKey:e}}),"__DISCONNECTED"===E&&O(G,!0)};void 0===G?(G=RANDOM_STR(40),n=d[G]={},t({ip:e.ip,headers:e.headers},U=function(E,_){var e=n[E];void 0===e&&(e=n[E]=[]),e.push(_)},u=function(E,_){var e=n[E];void 0!==e&&(void 0!==_?REMOVE({array:e,value:_}):delete n[E])},function(E,_){var e="__CALLBACK_"+i;E.sendKey=i,i+=1,N(G,E),void 0!==_&&U(e,function(E){_(E),u(e)})},function(){W("__DISCONNECTED")}),l({contentType:"text/javascript",content:"CONNECT_TO_WEB_SOCKET_SERVER.response('"+encodeURIComponent(STRINGIFY({clientId:G,connectionKey:f,requestKey:L}))+"')"})):M===!0?(RUN(function(){var e,o=void 0===R[G]?void 0:PARSE_STR(R[G][L]),t=void 0===o?void 0:o.methodName,n=void 0===o?void 0:o.data,d=void 0===o?void 0:o.sendKey;void 0!==t?(W(t,n,d),l({contentType:"text/javascript",content:"CONNECT_TO_WEB_SOCKET_SERVER.removeRequestInfo("+L+")"})):void 0!==S[G]?S[G]():(A(G,!0),e=function(){W("__DISCONNECTED")},S[G]=function(E){l({contentType:"text/javascript",content:"CONNECT_TO_WEB_SOCKET_SERVER.response('"+encodeURIComponent(STRINGIFY({connectionKey:f,clientId:G,params:E,requestKey:L}))+"')"}),I(G),C[G]=DELAY(_,e)},m(e),T[G]=DELAY(E,function(){void 0!==S[G]&&S[G]()}),void 0!==a[G]&&(S[G](a[G][0]),s(G,!0)))}),r(G,L,!0)):(c(G,L,P,!0),l({contentType:"text/javascript",content:"CONNECT_TO_WEB_SOCKET_SERVER.request("+L+")"}))},console.log("[UPPERCASE.IO-WEB_SOCKET_FIX_REQUEST_MANAGER] RUNNING WEB SOCKET FIX REQUEST MANAGER...")}}}),global.WEB_SOCKET_SERVER=WEB_SOCKET_SERVER=METHOD({run:function(E,_){"use strict";var e,o,t,n=require("ws").Server;CHECK_IS_DATA(E)!==!0?e=E:o=E,t=new n({port:e,server:void 0===o?void 0:o.getNativeHTTPServer()}),t.on("connection",function(E){var e,o,t,n,R,d=E.upgradeReq.headers,i={},S=0,a=function(E,_,e){var o=i[E];void 0!==o&&EACH(o,function(E){E(_,function(E){void 0!==e&&R({methodName:"__CALLBACK_"+e,data:E})})})};E.on("message",function(E){var _=PARSE_STR(E);void 0!==_&&a(_.methodName,_.data,_.sendKey)}),E.on("close",function(){o!==!0&&a("__DISCONNECTED"),i=void 0}),E.on("error",function(E){var _=E.toString();console.log("[UPPERCASE.IO-WEB_SOCEKT_SERVER] ERROR:",_),a("__ERROR",_)}),e=d["x-forwarded-for"],void 0===e&&(e=E.upgradeReq.connection.remoteAddress),_({ip:e,headers:d},t=function(E,_){var e=i[E];void 0===e&&(e=i[E]=[]),e.push(_)},n=function(E,_){var e=i[E];void 0!==e&&(void 0!==_?REMOVE({array:e,value:_}):delete i[E])},R=function(_,e){var o="__CALLBACK_"+S;_.sendKey=S,S+=1;try{E.send(STRINGIFY(_))}catch(R){console.log("[UPPERCASE.JS-SOCEKT_SERVER] ERROR:",R.toString())}void 0!==e&&t(o,function(E){e(E),n(o)})},function(){o=!0,E.close()})}),console.log("[UPPERCASE.IO-WEB_SOCKET_SERVER] RUNNING WEB SOCKET SERVER..."+(void 0===e?"":" (PORT:"+e+")"))}});