global.MULTI_PROTOCOL_SOCKET_SERVER=CLASS({init:function(e,t,S,r){"use strict";var E,o,i=S.socketServerPort,R=S.webSocketServerPort,_=S.isCreateWebSocketFixRequestManager,v=S.webServer;void 0!==i&&SOCKET_SERVER(i,r),(void 0!==R||void 0!==v)&&WEB_SOCKET_SERVER(void 0!==R?R:v,r),_===!0&&(E=WEB_SOCKET_FIX_REQUEST_MANAGER(r)),t.getWebSocketFixRequest=o=function(){return E.request}}});global.WEB_SOCKET_FIX_REQUEST_MANAGER=CLASS(function(){"use strict";var _=5,E=2;return{init:function(e,t,o){var n,R={},d={},a=0,T={},C={},i={},N={},S=function(_,E,e,t){void 0===R[_]&&(R[_]={}),void 0===R[_][E]?R[_][E]=e:R[_][E]+=e,t===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__ADD_CONTENT",data:{clientId:_,requestKey:E,content:e}})},c=function(_,E,e){void 0!==R[_]&&delete R[_][E],e===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_CONTENT",data:{clientId:_,requestKey:E}})},I=function(_,E){void 0!==T[_]?T[_](E):r(_,E,!0)},U=function(_,E,e,t){var o;try{o=d[_][E],void 0!==o&&EACH(o,function(E){E(e,function(E){void 0!==t&&I(_,{methodName:"__CALLBACK_"+t,data:E})})})}catch(n){console.log(CONSOLE_RED("[UPPERCASE.IO-WEB_SOCKET_FIX_REQUEST_MANAGER] ERROR:"),n.toString())}},A=function(_){void 0!==i[_]&&(i[_].remove(),delete i[_]),delete T[_]},r=function(_,E,e){void 0===C[_]&&(C[_]=[]),C[_].push(E),e===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__SEND",data:{clientId:_,params:E}})},O=function(_,E){REMOVE({array:C[_],key:0}),0===C[_].length&&delete C[_],E===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_FIRST_WATING_PARAMS",data:_})},v=function(_,E){void 0!==N[_]&&(N[_].remove(),delete N[_]),E===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_LIFE_DELAY",data:_})},s=function(_,E){A(_),void 0!==d[_]&&delete d[_],void 0!==C[_]&&delete C[_],v(_),void 0!==R[_]&&delete R[_],E===!0&&void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_ALL",data:_})};void 0!==CPU_CLUSTERING.on&&(CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__RUN_METHODS",function(_){var E=_.clientId;void 0!==d[E]&&U(E,_.methodName,_.data,_.sendKey)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_FIRST_WATING_PARAMS",function(_){void 0!==C[_]&&O(_)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__SEND",function(_){var E=_.clientId,e=_.params;void 0!==T[E]?(T[E](e),void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_FIRST_WATING_PARAMS",data:E})):r(E,e)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_LIFE_DELAY",function(_){v(_)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_ALL",function(_){s(_)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__ADD_CONTENT",function(_){S(_.clientId,_.requestKey,_.content)}),CPU_CLUSTERING.on("__WEB_SOCKET_FIX_REQUEST_MANAGER__REMOVE_CONTENT",function(_){c(_.clientId,_.requestKey)})),t.request=n=function(e,t){var n,r,G,u=e.params,L=u.clientId,K=INTEGER(u.connectionKey),M=INTEGER(u.requestKey),m=u.content,f="true"===u.isEnd,P=t.response,l=t.onDisconnected,F=function(_,E,e){void 0!==d[L]?U(L,_,E,e):void 0!==CPU_CLUSTERING.broadcast&&CPU_CLUSTERING.broadcast({methodName:"__WEB_SOCKET_FIX_REQUEST_MANAGER__RUN_METHODS",data:{clientId:L,methodName:_,data:E,sendKey:e}}),"__DISCONNECTED"===_&&s(L,!0)};void 0===L?(L=RANDOM_STR(40),n=d[L]={},o({ip:e.ip,headers:e.headers},r=function(_,E){var e=n[_];void 0===e&&(e=n[_]=[]),e.push(E)},G=function(_,E){var e=n[_];void 0!==e&&(void 0!==E?REMOVE({array:e,value:E}):delete n[_])},function(_,E){var e="__CALLBACK_"+a;_.sendKey=a,a+=1,I(L,_),void 0!==E&&r(e,function(_){E(_),G(e)})},function(){F("__DISCONNECTED")}),P({contentType:"text/javascript",content:"CONNECT_TO_WEB_SOCKET_SERVER.response('"+encodeURIComponent(STRINGIFY({clientId:L,connectionKey:K,requestKey:M})).replace(/'/g,"\\'")+"')"})):f===!0?(RUN(function(){var e,t,o,n,d=void 0===R[L]?void 0:PARSE_STR(R[L][M]);void 0!==d&&(e=d.methodName,t=d.data,o=d.sendKey),void 0!==e?(F(e,t,o),P({contentType:"text/javascript",content:"CONNECT_TO_WEB_SOCKET_SERVER.removeRequestInfo("+M+")"})):void 0!==T[L]?T[L]():(v(L,!0),n=function(){F("__DISCONNECTED")},T[L]=function(_){P({contentType:"text/javascript",content:"CONNECT_TO_WEB_SOCKET_SERVER.response('"+encodeURIComponent(STRINGIFY({connectionKey:K,clientId:L,params:_,requestKey:M})).replace(/'/g,"\\'")+"')"}),A(L),N[L]=DELAY(E,n)},l(n),i[L]=DELAY(_,function(){void 0!==T[L]&&T[L]()}),void 0!==C[L]&&(T[L](C[L][0]),O(L,!0)))}),c(L,M,!0)):(S(L,M,m,!0),P({contentType:"text/javascript",content:"CONNECT_TO_WEB_SOCKET_SERVER.request("+M+")"}))},console.log("[UPPERCASE.IO-WEB_SOCKET_FIX_REQUEST_MANAGER] RUNNING WEB SOCKET FIX REQUEST MANAGER...")}}});global.WEB_SOCKET_SERVER=METHOD({run:function(o,e){"use strict";var n,E,r,R=require("ws").Server;CHECK_IS_DATA(o)!==!0?n=o:E=o,r=new R({port:n,server:void 0===E?void 0:E.getNativeHTTPServer()}),r.on("connection",function(o){var n,E,r,R,t=o.upgradeReq.headers,i={},c=0,d=function(o,e,n){var E;try{E=i[o],void 0!==E&&EACH(E,function(o){o(e,function(o){void 0!==n&&R({methodName:"__CALLBACK_"+n,data:o})})})}catch(r){console.log(CONSOLE_RED("[UPPERCASE.IO-WEB_SOCEKT_SERVER] ERROR:"),r.toString())}};o.on("message",function(o){var e=PARSE_STR(o);void 0!==e&&d(e.methodName,e.data,e.sendKey)}),o.on("close",function(){d("__DISCONNECTED"),i=void 0}),o.on("error",function(o){var e=o.toString();console.log(CONSOLE_RED("[UPPERCASE.IO-WEB_SOCEKT_SERVER] ERROR:"),e),d("__ERROR",e)}),n=t["x-forwarded-for"],void 0===n&&(n=o.upgradeReq.connection.remoteAddress),e({ip:n,headers:t},E=function(o,e){var n=i[o];void 0===n&&(n=i[o]=[]),n.push(e)},r=function(o,e){var n=i[o];void 0!==n&&(void 0!==e?REMOVE({array:n,value:e}):delete i[o])},R=function(e,n){var R="__CALLBACK_"+c;e.sendKey=c,c+=1;try{o.send(STRINGIFY(e))}catch(t){console.log("[UPPERCASE.IO-WEB_SOCEKT_SERVER] ERROR:",t.toString())}void 0!==n&&E(R,function(o){n(o),r(R)})},function(){o.close()})}),console.log("[UPPERCASE.IO-WEB_SOCKET_SERVER] RUNNING WEB SOCKET SERVER..."+(void 0===n?"":" (PORT:"+n+")"))}});