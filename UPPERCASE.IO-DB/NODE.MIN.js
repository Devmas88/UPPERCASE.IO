global.CONNECT_TO_DB_SERVER=METHOD(function(o){var n,i,t=[];return o.addInitDBFunc=i=function(o){void 0===n?t.push(o):o(n)},{run:function(o,i){"use strict";var E=o.username,r=o.password,d=void 0===o.host?"127.0.0.1":o.host,u=void 0===o.port?27017:o.port,c=o.name;require("mongodb").MongoClient.connect("mongodb://"+(void 0!==E&&void 0!==r?E+":"+r+"@":"")+d+":"+u+"/"+c,function(o,E){o!==TO_DELETE?console.log(CONSOLE_RED("[UPPERCASE.IO-DB] CONNECT TO DB SERVER FAILED: "+o.toString())):(n=E,EACH(t,function(o){o(n)}),t=void 0,void 0!==i&&i())})}}});FOR_BOX(function(t){"use strict";var o=require("mongodb").ObjectID,e=require("sift");t.DB=CLASS({init:function(r,i,n){var a,c,d,s,u,E,f,l,v,A,_,S,m,C,O=[],T=[],g=[],I=[],H=[],h=[],D=[],R=[],p=[],N=[],L=[],x=function(t){return c===!0?t:VALID.id(t)===!0?new o(t):-1},M=function(t){void 0!==t._id&&(t.id=t._id.toString()),delete t._id,delete t.__RANDOM_KEY},b=function(t){EACH(t,function(o,e){void 0===o||o===TO_DELETE?REMOVE({data:t,name:e}):(CHECK_IS_DATA(o)===!0||CHECK_IS_ARRAY(o)===!0)&&b(o)})},k=function(t){var o=function(t){void 0!==t.id&&(CHECK_IS_DATA(t.id)===!0?(EACH(t.id,function(o,e){CHECK_IS_DATA(o)===!0||CHECK_IS_ARRAY(o)===!0?EACH(o,function(t,e){o[e]=x(t)}):t.id[e]=x(o)}),t._id=t.id):t._id=x(t.id),delete t.id),EACH(t,function(o,e){void 0===o&&delete t[e]})};void 0!==t.$and?EACH(t.$and,function(t){o(t)}):void 0!==t.$or?EACH(t.$or,function(t){o(t)}):o(t)},K=function(t){var e={},r=function(t,e){void 0!==e._id&&(e._id instanceof o==!0?t.id=e._id.toString():CHECK_IS_DATA(e.id)===!0?(t.id={},EACH(e._id,function(o,e){CHECK_IS_DATA(o)===!0?(t.id[e]={},EACH(o,function(o,r){t.id[e][r]=o.toString()})):CHECK_IS_ARRAY(o)===!0?(t.id[e]=[],EACH(o,function(o){t.id[e].push(o.toString())})):t.id[e]=o.toString()})):t.id=e._id),EACH(e,function(o,e){"_id"!==e&&(t[e]=o)})};return void 0!==t.$and?(e.$and=[],EACH(t.$and,function(t){var o={};e.$and.push(o),r(o,t)})):void 0!==t.$or?(e.$or=[],EACH(t.$or,function(t){var o={};e.$or.push(o),r(o,t)})):r(e,t),e};CHECK_IS_DATA(n)!==!0?a=n:(a=n.name,c=n.isNotUsingObjectId,d=n.isNotUsingHistory),i.create=s=function(t,o){O.push({data:t,callbackOrHandlers:o})},i.get=u=function(t,o){T.push({idOrParams:t,callbackOrHandlers:o})},i.update=E=function(t,o){g.push({data:t,callbackOrHandlers:o})},c!==!0&&(i.remove=f=function(t,o){I.push({id:t,callbackOrHandlers:o})}),i.find=l=function(t,o){H.push({params:t,callbackOrHandlers:o})},i.count=v=function(t,o){h.push({params:t,callbackOrHandlers:o})},i.checkIsExists=A=function(t,o){D.push({params:t,callbackOrHandlers:o})},i.aggregate=_=function(t,o){R.push({params:t,callbackOrHandlers:o})},i.createIndex=S=function(t,o){p.push({keys:t,callbackOrHandlers:o})},i.removeIndex=m=function(t,o){N.push({index:t,callbackOrHandlers:o})},i.findAllIndexes=C=function(t){L.push({callbackOrHandlers:t})},CONNECT_TO_DB_SERVER.addInitDBFunc(function(o){var r,n=o.collection(t.boxName+"."+a),L=o.collection(t.boxName+"."+a+"__HISTORY"),P=o.collection(t.boxName+"."+a+"__ERROR"),Y=t.SHARED_STORE("cachedGetStore"),y=t.SHARED_STORE("cachedFindStore"),$=t.SHARED_STORE("cachedCountStore"),F=function(o,e,r,i){L.findOne({_id:e},function(t,n){var a;t===TO_DELETE&&(a={method:o,time:i},void 0!==r&&(a.change=r),n===TO_DELETE?L.insert({_id:e,timeline:[a]},{w:0}):L.update({_id:e},{$push:{timeline:a}},{w:0}))}),NODE_CONFIG.isDBLogMode===!0&&("remove"===o?console.log("[UPPERCASE.IO-DB] `"+t.boxName+"."+a+"` DATA("+e+") REMOVED."):console.log("[UPPERCASE.IO-DB] `"+t.boxName+"."+a+"` DATA("+e+") SAVED:",r))},B=function(o,e){o.time=new Date;try{P.insert(o,{w:0})}catch(r){}void 0!==e?e(o.errorMsg):console.log(CONSOLE_RED("[UPPERCASE.IO-DB] `"+t.boxName+"."+a+"` ERROR:"),o)},G=function(t,o){var r=[],i=[],n=[];EACH(Y.list(),function(o,i){var n=o.filter;e(n)(t)===!0&&r.push({filter:n,paramsStr:i})}),EACH(y.list(),function(o,r){var n=o.filter;e(n)(t)===!0&&i.push({filter:n,paramsStr:r})}),EACH($.list(),function(o,r){var i=o.filter;e(i)(t)===!0&&n.push({filter:i,paramsStr:r})}),PARALLEL([function(t){PARALLEL(r,[function(t,o){var e=t.paramsStr;u(PARSE_STR(e),{notExists:function(){Y.remove(e),o()},error:function(){Y.remove(e),o()},success:function(r){Y.save({name:e,value:{filter:t.filter,data:r}}),o()}})},function(){t()}])},function(t){PARALLEL(i,[function(t,o){var e=t.paramsStr;l(PARSE_STR(e),{error:function(){y.remove(e),o()},success:function(r){y.save({name:e,value:{filter:t.filter,dataSet:r}}),o()}})},function(){t()}])},function(t){PARALLEL(n,[function(t,o){var e=t.paramsStr;v(PARSE_STR(e),{error:function(){$.remove(e),o()},success:function(r){$.save({name:e,value:{filter:t.filter,count:r}}),o()}})},function(){t()}])},function(){o()}])};i.create=s=function(t,o){var e,r;try{t.__RANDOM_KEY=Math.random(),t.createTime=new Date,b(t),delete t._id,c===!0&&(t._id=t.id),delete t.id,void 0!==o&&(CHECK_IS_DATA(o)!==!0?e=o:(e=o.success,r=o.error)),n.insert(t,{safe:!0},function(o,i){var n;o===TO_DELETE?(n=i[0],M(n),d!==!0&&F("create",n.id,n,n.createTime),G(n,function(){void 0!==e&&e(n)})):B({method:"create",data:t,errorMsg:o.toString()},r)})}catch(i){B({method:"create",data:t,errorMsg:i.toString()},r)}},r=function(o,e){var r,i,c,d,s,u=o.filter,E=o.sort,f=o.isToCache;try{k(u),CHECK_IS_DATA(e)!==!0?r=e:(r=e.success,i=e.notExists,c=e.error),f===!0&&(d=K(u),s=Y.get(STRINGIFY({filter:d,sort:E}))),void 0!==s?r(s.data):n.find(u).sort(E).limit(1).toArray(function(e,n){var s;e===TO_DELETE?n.length>0?(s=n[0],M(s),f===!0&&Y.save({name:STRINGIFY({filter:d,sort:E}),value:{filter:d,data:s}}),r(s)):void 0!==i?i():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+t.boxName+"."+a+".get` NOT EXISTS."),u):B({method:"get",params:o,errorMsg:e.toString()},c)})}catch(l){B({method:"get",params:o,errorMsg:l.toString()},c)}},i.get=u=function(t,o){var e,i,n,a,c,d,s,u,E;try{CHECK_IS_DATA(t)!==!0?e=t:(e=t.id,i=t.filter,n=t.sort,a=t.isRandom,c=t.isToCache),CHECK_IS_DATA(o)!==!0?d=o:(d=o.success,s=o.notExists,u=o.error),void 0===n&&(n={createTime:-1}),a===!0?(void 0===i&&(i={}),i.__RANDOM_KEY={$gte:E=Math.random()},n.__RANDOM_KEY=1,r({filter:i,sort:n},{error:u,notExists:function(){i.__RANDOM_KEY={$lte:E},r({filter:i,sort:n},o)},success:d})):(void 0===i&&(i={_id:x(e)}),r({filter:i,sort:n,isToCache:c},o))}catch(f){B({method:"get",idOrParams:t,errorMsg:f.toString()},u)}},i.update=E=function(o,e){var r,i,c,s,E,f,l,v=o.id,A=o.$inc;try{i={_id:x(v)},void 0!==e&&(CHECK_IS_DATA(e)!==!0?c=e:(c=e.success,s=e.notExists,E=e.error)),EACH(o,function(t,e){"id"===e||"_id"===e||"createTime"===e||"$inc"===e?delete o[e]:t===TO_DELETE?(void 0===r&&(r={}),r[e]=""):l=!0}),o.lastUpdateTime=new Date,b(o),f={$set:o},void 0!==r&&(f.$unset=r),void 0!==A&&(f.$inc=A),u({filter:i},{error:function(t){B({method:"update",data:o,errorMsg:t},E)},notExists:function(){void 0!==s?s():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+t.boxName+"."+a+".update` NOT EXISTS."),i)},success:function(e){n.update(i,f,{safe:!0},function(n,f){0===f?void 0!==s?s():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+t.boxName+"."+a+".update` NOT EXISTS."),i):n===TO_DELETE?u({filter:i},{error:function(t){B({method:"update",data:o,errorMsg:t},E)},notExists:function(){void 0!==s?s():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+t.boxName+"."+a+".update` NOT EXISTS."),i)},success:function(t){var i;(void 0===A||l===!0||void 0!==r)&&(i={},l===!0&&EACH(o,function(t,o){i[o]=t}),void 0!==r&&EACH(r,function(t,o){i[o]=TO_DELETE}),d!==!0&&F("update",v,i,t.lastUpdateTime)),G(e,function(){void 0!==c&&c(t)})}}):B({method:"update",data:o,errorMsg:n.toString()},E)})}})}catch(_){B({method:"update",data:o,errorMsg:_.toString()},E)}},c!==!0&&(i.remove=f=function(o,e){var r,i,c,s;try{r={_id:x(o)},void 0!==e&&(CHECK_IS_DATA(e)!==!0?i=e:(i=e.success,c=e.notExists,s=e.error)),u({filter:r},{error:function(t){B({method:"remove",id:o,errorMsg:t},s)},notExists:function(){void 0!==c?c():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+t.boxName+"."+a+".remove` NOT EXISTS."),r)},success:function(e){n.remove(r,{safe:!0},function(n,u){0===u?void 0!==c?c():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+t.boxName+"."+a+".remove` NOT EXISTS."),r):n===TO_DELETE?(d!==!0&&F("remove",o,void 0,new Date),G(e,function(){void 0!==i&&i(e)})):B({method:"remove",id:o,errorMsg:n.toString()},s)})}})}catch(E){B({method:"remove",id:o,errorMsg:E.toString()},s)}}),i.find=l=function(t,o){var e,r,i,a,c,d,s,u,E,f,l;try{void 0===o&&(o=t,t=void 0),void 0!==t&&(e=t.filter,r=t.sort,i=INTEGER(t.start),a=INTEGER(t.count),c=t.isFindAll,d=t.isToCache),CHECK_IS_DATA(o)!==!0?s=o:(s=o.success,u=o.error),void 0===e&&(e={}),void 0===r&&(r={createTime:-1}),void 0===i&&(i=0),c!==!0&&(void 0===a||a>NODE_CONFIG.maxDataCount||isNaN(a)===!0?a=NODE_CONFIG.maxDataCount:1>a&&(a=1)),k(e),d===!0&&(E=K(e),f=y.get(STRINGIFY({filter:E,sort:r,start:i,count:a,isFindAll:c}))),void 0!==f?s(f.dataSet):(l=function(o,e){o===TO_DELETE?(EACH(e,function(t){M(t)}),d===!0&&y.save({name:STRINGIFY({filter:E,sort:r,start:i,count:a,isFindAll:c}),value:{filter:E,dataSet:e}}),s(e)):B({method:"find",params:t,errorMsg:o.toString()},u)},c===!0?n.find(e).sort(r).skip(i).toArray(l):n.find(e).sort(r).skip(i).limit(a).toArray(l))}catch(v){B({method:"find",params:t,errorMsg:v.toString()},u)}},i.count=v=function(t,o){var e,r,i,a,c,d;try{void 0===o&&(o=t,t=void 0),void 0!==t&&(e=t.filter,r=t.isToCache),void 0===o&&(o=e,e=void 0),void 0===e&&(e={}),CHECK_IS_DATA(o)!==!0?i=o:(i=o.success,a=o.error),k(e),r===!0&&(c=K(e),d=$.get(STRINGIFY({filter:c}))),void 0!==d?i(d.count):n.find(e).count(function(t,o){t===TO_DELETE?(r===!0&&$.save({name:STRINGIFY({filter:c}),value:{filter:c,count:o}}),i(o)):B({method:"count",filter:e,errorMsg:t.toString()},a)})}catch(s){B({method:"count",filter:e,errorMsg:s.toString()},a)}},i.checkIsExists=A=function(t,o){var e,r,i,a,c,d,s;try{void 0===o&&(o=t,t=void 0),void 0!==t&&(e=t.filter,r=t.isToCache),void 0===o&&(o=e,e=void 0),void 0===e?e={}:CHECK_IS_DATA(e)!==!0&&(e={_id:x(e)}),CHECK_IS_DATA(o)!==!0?i=o:(i=o.success,a=o.error),k(e),r===!0&&(c=K(e),d=$.get(STRINGIFY({filter:c}))),void 0!==d?(s=d.count,i(void 0!==s&&s>0)):n.find(e).count(function(t,o){t===TO_DELETE?(r===!0&&$.save({name:STRINGIFY({filter:c}),value:{filter:c,count:o}}),i(void 0!==o&&o>0)):B({method:"checkIsExists",filter:e,errorMsg:t.toString()},a)})}catch(u){B({method:"checkIsExists",filter:e,errorMsg:u.toString()},a)}},i.aggregate=_=function(t,o){var e,r;try{CHECK_IS_DATA(o)!==!0?e=o:(e=o.success,r=o.error),n.aggregate(t,function(o,i){o===TO_DELETE?e(i):B({method:"aggregate",params:t,errorMsg:o.toString()},r)})}catch(i){B({method:"aggregate",params:t,errorMsg:i.toString()},r)}},i.createIndex=S=function(t,o){var e,r;try{void 0!==o&&(CHECK_IS_DATA(o)!==!0?e=o:(e=o.success,r=o.error)),n.ensureIndex(t,{safe:!0},function(o){o===TO_DELETE?void 0!==e&&e():B({method:"createIndex",keys:t,errorMsg:o.toString()},r)})}catch(i){B({method:"createIndex",keys:t,errorMsg:i.toString()},r)}},i.removeIndex=m=function(t,o){var e,r;try{void 0!==o&&(CHECK_IS_DATA(o)!==!0?e=o:(e=o.success,r=o.error)),n.dropIndex(t,{safe:!0},function(o){o===TO_DELETE?void 0!==e&&e():B({method:"removeIndex",index:t,errorMsg:o.toString()},r)})}catch(i){B({method:"removeIndex",index:t,errorMsg:i.toString()},r)}},i.findAllIndexes=C=function(t){var o,e;try{CHECK_IS_DATA(t)!==!0?o=t:(o=t.success,e=t.error),n.indexInformation(function(t,r){var i;t===TO_DELETE?(i=[],EACH(r,function(t){var o={};EACH(t,function(t){o[t[0]]=t[1]}),i.push(o)}),o(i)):B({method:"findAllIndexes",errorMsg:t.toString()},e)})}catch(r){B({method:"findAllIndexes",errorMsg:r.toString()},e)}},EACH(O,function(t){s(t.data,t.callbackOrHandlers)}),O=void 0,EACH(T,function(t){u(t.idOrParams,t.callbackOrHandlers)}),T=void 0,EACH(g,function(t){E(t.data,t.callbackOrHandlers)}),g=void 0,EACH(I,function(t){f(t.id,t.callbackOrHandlers)}),I=void 0,EACH(H,function(t){l(t.params,t.callbackOrHandlers)}),H=void 0,EACH(h,function(t){v(t.params,t.callbackOrHandlers)}),h=void 0,EACH(D,function(t){A(t.params,t.callbackOrHandlers)}),D=void 0,EACH(R,function(t){_(t.params,t.callbackOrHandlers)}),R=void 0,EACH(p,function(t){S(t.keys,t.callbackOrHandlers)}),p=void 0,EACH(N,function(t){m(t.index,t.callbackOrHandlers)}),N=void 0})}})});FOR_BOX(function(n){"use strict";n.LOG_DB=CLASS({init:function(i,t,o){var c,u=[];t.log=c=function(n){u.push(n)},CONNECT_TO_DB_SERVER.addInitDBFunc(function(i){var e=i.collection(n.boxName+"."+o);t.log=c=function(n){n.time=new Date,e.insert(n,{w:0})},EACH(u,function(n){c(n)}),u=void 0})}})});OVERRIDE(NODE_CONFIG,function(O){global.NODE_CONFIG=COMBINE([O,{isDBLogMode:!1,maxDataCount:1e3}])});