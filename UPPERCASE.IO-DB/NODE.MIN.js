global.CONNECT_TO_DB_SERVER=METHOD(function(o){var n,i,t=[];return o.addInitDBFunc=i=function(o){void 0===n?t.push(o):o(n)},{run:function(o,i){"use strict";var E=o.username,r=o.password,d=void 0===o.host?"127.0.0.1":o.host,u=void 0===o.port?27017:o.port,c=o.name;require("mongodb").MongoClient.connect("mongodb://"+(void 0!==E&&void 0!==r?E+":"+r+"@":"")+d+":"+u+"/"+c,function(o,E){o!==TO_DELETE?console.log(CONSOLE_RED("[UPPERCASE.IO-DB] CONNECT TO DB SERVER FAILED: "+o.toString())):(n=E,EACH(t,function(o){o(n)}),t=void 0,void 0!==i&&i())})}}});FOR_BOX(function(e){"use strict";var t=require("mongodb").ObjectID;e.DB=CLASS({init:function(o,r,n){var i,a,c,s,d,E,u,l,f,v,A,_,m,S,C=[],T=[],O=[],g=[],I=[],h=[],D=[],H=[],R=[],p=[],N=[],L=function(e){return a===!0?e:VALID.id(e)===!0?new t(e):-1},x=function(e){return void 0!==e._id&&(e.id=e._id.toString()),delete e._id,delete e.__RANDOM_KEY,e},M=function(e){EACH(e,function(t,o){void 0===t||t===TO_DELETE?REMOVE({data:e,name:o}):(CHECK_IS_DATA(t)===!0||CHECK_IS_ARRAY(t)===!0)&&M(t)})},b=function(e){var t=function(e){void 0!==e.id&&(CHECK_IS_DATA(e.id)===!0?(EACH(e.id,function(t,o){CHECK_IS_DATA(t)===!0||CHECK_IS_ARRAY(t)===!0?EACH(t,function(e,o){t[o]=L(e)}):e.id[o]=L(t)}),e._id=e.id):e._id=L(e.id),delete e.id),EACH(e,function(t,o){void 0===t&&delete e[o]})};void 0!==e.$and?EACH(e.$and,function(e){t(e)}):void 0!==e.$or?EACH(e.$or,function(e){t(e)}):t(e)};CHECK_IS_DATA(n)!==!0?i=n:(i=n.name,a=n.isNotUsingObjectId,c=n.isNotUsingHistory),r.create=s=function(e,t){C.push({data:e,callbackOrHandlers:t})},r.get=d=function(e,t){T.push({idOrParams:e,callbackOrHandlers:t})},r.update=E=function(e,t){O.push({data:e,callbackOrHandlers:t})},a!==!0&&(r.remove=u=function(e,t){g.push({id:e,callbackOrHandlers:t})}),r.find=l=function(e,t){I.push({params:e,callbackOrHandlers:t})},r.count=f=function(e,t){h.push({params:e,callbackOrHandlers:t})},r.checkIsExists=v=function(e,t){D.push({params:e,callbackOrHandlers:t})},r.aggregate=A=function(e,t){H.push({params:e,callbackOrHandlers:t})},r.createIndex=_=function(e,t){R.push({keys:e,callbackOrHandlers:t})},r.removeIndex=m=function(e,t){p.push({index:e,callbackOrHandlers:t})},r.findAllIndexes=S=function(e){N.push({callbackOrHandlers:e})},CONNECT_TO_DB_SERVER.addInitDBFunc(function(t){var o,n=t.collection(e.boxName+"."+i),N=t.collection(e.boxName+"."+i+"__HISTORY"),k=t.collection(e.boxName+"."+i+"__ERROR"),P=e.SHARED_STORE("cachedGetStore"),K=e.SHARED_STORE("cachedFindStore"),y=e.SHARED_STORE("cachedCountStore"),Y=function(t,o,r,n){N.findOne({_id:o},function(e,i){var a;e===TO_DELETE&&(a={method:t,time:n},void 0!==r&&(a.change=r),i===TO_DELETE?N.insert({_id:o,timeline:[a]},{w:0}):N.update({_id:o},{$push:{timeline:a}},{w:0}))}),NODE_CONFIG.isDBLogMode===!0&&("remove"===t?console.log("[UPPERCASE.IO-DB] `"+e.boxName+"."+i+"` DATA("+o+") REMOVED."):console.log("[UPPERCASE.IO-DB] `"+e.boxName+"."+i+"` DATA("+o+") SAVED:",r))},F=function(t,o){t.time=new Date;try{k.insert(t,{w:0})}catch(r){}void 0!==o?o(t.errorMsg):console.log("[UPPERCASE.IO-DB] `"+e.boxName+"."+i+"` ERROR:",t)},G=function(e){var t=[],o=[],r=[];EACH(P.list(),function(e,o){t.push({cachedData:e,paramsStr:o})}),EACH(K.list(),function(e,t){o.push({cachedDataSet:e,paramsStr:t})}),EACH(y.list(),function(e,t){r.push({cachedCount:e,paramsStr:t})}),PARALLEL([function(e){PARALLEL(t,[function(e,t){var o=e.paramsStr;d(PARSE_STR(o),{notExists:function(){P.remove(o),t()},error:function(){P.remove(o),t()},success:function(e){P.save({name:o,value:e}),t()}})},function(){e()}])},function(e){PARALLEL(o,[function(e,t){var o=e.paramsStr;l(PARSE_STR(o),{error:function(){K.remove(o),t()},success:function(e){K.save({name:o,value:e}),t()}})},function(){e()}])},function(e){PARALLEL(r,[function(e,t){var o=e.paramsStr;f(PARSE_STR(o),{error:function(){y.remove(o),t()},success:function(e){y.save({name:o,value:e}),t()}})},function(){e()}])},function(){e()}])};r.create=s=function(e,t){var o,r;try{e.__RANDOM_KEY=Math.random(),e.createTime=new Date,M(e),delete e._id,a===!0&&(e._id=e.id),delete e.id,void 0!==t&&(CHECK_IS_DATA(t)!==!0?o=t:(o=t.success,r=t.error)),n.insert(e,{safe:!0},function(t,n){var i;t===TO_DELETE?(i=n[0],x(i),c!==!0&&Y("create",i.id,i,i.createTime),G(function(){void 0!==o&&o(i)})):F({method:"create",data:e,errorMsg:t.toString()},r)})}catch(i){F({method:"create",data:e,errorMsg:i.toString()},r)}},o=function(t,o){var r,a,c,s,d=t.filter,E=t.sort,u=t.isToCache;try{b(d),CHECK_IS_DATA(o)!==!0?r=o:(r=o.success,a=o.notExists,c=o.error),u===!0&&(s=P.get(STRINGIFY({filter:d,sort:E}))),void 0!==s?r(s):n.find(d).sort(E).limit(1).toArray(function(o,n){var s;o===TO_DELETE?n.length>0?(s=n[0],x(s),u===!0&&P.save({name:STRINGIFY({filter:d,sort:E}),value:s}),r(s)):void 0!==a?a():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+e.boxName+"."+i+".get` NOT EXISTS."),d):F({method:"get",params:t,errorMsg:o.toString()},c)})}catch(l){F({method:"get",params:t,errorMsg:l.toString()},c)}},r.get=d=function(e,t){var r,n,i,a,c,s,d,E,u;try{CHECK_IS_DATA(e)!==!0?r=e:(r=e.id,n=e.filter,i=e.sort,a=e.isRandom,c=e.isToCache),CHECK_IS_DATA(t)!==!0?s=t:(s=t.success,d=t.notExists,E=t.error),void 0===i&&(i={createTime:-1}),a===!0?(void 0===n&&(n={}),n.__RANDOM_KEY={$gte:u=Math.random()},i.__RANDOM_KEY=1,o({filter:n,sort:i,isToCache:c},{error:E,notExists:function(){n.__RANDOM_KEY={$lte:u},o({filter:n,sort:i},t)},success:s})):(void 0===n&&(n={_id:L(r)}),o({filter:n,sort:i,isToCache:c},t))}catch(l){F({method:"get",idOrParams:e,errorMsg:l.toString()},E)}},r.update=E=function(t,o){var r,a,s,E,u,l,f,v=t.id,A=t.$inc;try{a={_id:L(v)},void 0!==o&&(CHECK_IS_DATA(o)!==!0?s=o:(s=o.success,E=o.notExists,u=o.error)),EACH(t,function(e,o){"id"===o||"_id"===o||"createTime"===o||"$inc"===o?delete t[o]:e===TO_DELETE?(void 0===r&&(r={}),r[o]=""):f=!0}),t.lastUpdateTime=new Date,M(t),l={$set:t},void 0!==r&&(l.$unset=r),void 0!==A&&(l.$inc=A),n.update(a,l,{safe:!0},function(o,n){0===n?void 0!==E?E():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+e.boxName+"."+i+".update` NOT EXISTS."),a):o===TO_DELETE?d({filter:a},{error:function(e){F({method:"update",data:t,errorMsg:e},u)},notExists:function(){void 0!==E?E():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+e.boxName+"."+i+".update` NOT EXISTS."),a)},success:function(e){var o;(void 0===A||f===!0||void 0!==r)&&(o={},f===!0&&EACH(t,function(e,t){o[t]=e}),void 0!==r&&EACH(r,function(e,t){o[t]=TO_DELETE}),c!==!0&&Y("update",v,o,e.lastUpdateTime)),x(e),G(function(){void 0!==s&&s(e)})}}):F({method:"update",data:t,errorMsg:o.toString()},u)})}catch(_){F({method:"update",data:t,errorMsg:_.toString()},u)}},a!==!0&&(r.remove=u=function(t,o){var r,a,s,E;try{r={_id:L(t)},void 0!==o&&(CHECK_IS_DATA(o)!==!0?a=o:(a=o.success,s=o.notExists,E=o.error)),d({filter:r},{error:function(e){F({method:"remove",id:t,errorMsg:e},E)},notExists:function(){void 0!==s?s():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+e.boxName+"."+i+".remove` NOT EXISTS."),r)},success:function(o){n.remove(r,{safe:!0},function(n,d){0===d?void 0!==s?s():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+e.boxName+"."+i+".remove` NOT EXISTS."),r):n===TO_DELETE?(c!==!0&&Y("remove",t,void 0,new Date),x(o),G(function(){void 0!==a&&a(o)})):F({method:"remove",id:t,errorMsg:n.toString()},E)})}})}catch(u){F({method:"remove",id:t,errorMsg:u.toString()},E)}}),r.find=l=function(e,t){var o,r,i,a,c,s,d,E,u,l;try{void 0===t&&(t=e,e=void 0),void 0!==e&&(o=e.filter,r=e.sort,i=INTEGER(e.start),a=INTEGER(e.count),c=e.isFindAll,s=e.isToCache),CHECK_IS_DATA(t)!==!0?d=t:(d=t.success,E=t.error),void 0===o&&(o={}),void 0===r&&(r={createTime:-1}),void 0===i&&(i=0),c!==!0&&(void 0===a||a>NODE_CONFIG.maxDataCount||isNaN(a)===!0?a=NODE_CONFIG.maxDataCount:1>a&&(a=1)),b(o),s===!0&&(u=K.get(STRINGIFY({filter:o,sort:r,start:i,count:a,isFindAll:c}))),void 0!==u?d(u):(l=function(t,n){t===TO_DELETE?(EACH(n,function(e){x(e)}),s===!0&&K.save({name:STRINGIFY({filter:o,sort:r,start:i,count:a,isFindAll:c}),value:n}),d(n)):F({method:"find",params:e,errorMsg:t.toString()},E)},c===!0?n.find(o).sort(r).skip(i).toArray(l):n.find(o).sort(r).skip(i).limit(a).toArray(l))}catch(f){F({method:"find",params:e,errorMsg:f.toString()},E)}},r.count=f=function(e,t){var o,r,i,a,c;try{void 0===t&&(t=e,e=void 0),void 0!==e&&(o=e.filter,r=e.isToCache),void 0===t&&(t=o,o=void 0),void 0===o&&(o={}),CHECK_IS_DATA(t)!==!0?i=t:(i=t.success,a=t.error),b(o),r===!0&&(c=y.get(STRINGIFY({filter:o}))),void 0!==c?i(c):n.find(o).count(function(e,t){e===TO_DELETE?(r===!0&&y.save({name:STRINGIFY({filter:o}),value:t}),i(t)):F({method:"count",filter:o,errorMsg:e.toString()},a)})}catch(s){F({method:"count",filter:o,errorMsg:s.toString()},a)}},r.checkIsExists=v=function(e,t){var o,r,i,a,c;try{void 0===t&&(t=e,e=void 0),void 0!==e&&(o=e.filter,r=e.isToCache),void 0===t&&(t=o,o=void 0),void 0===o?o={}:CHECK_IS_DATA(o)!==!0&&(o={_id:L(o)}),CHECK_IS_DATA(t)!==!0?i=t:(i=t.success,a=t.error),b(o),r===!0&&(c=y.get(STRINGIFY({filter:o}))),void 0!==c?i(void 0!==c&&c>0):n.find(o).count(function(e,t){e===TO_DELETE?(r===!0&&y.save({name:STRINGIFY({filter:o}),value:t}),i(void 0!==t&&t>0)):F({method:"checkIsExists",filter:o,errorMsg:e.toString()},a)})}catch(s){F({method:"checkIsExists",filter:o,errorMsg:s.toString()},a)}},r.aggregate=A=function(e,t){var o,r;try{CHECK_IS_DATA(t)!==!0?o=t:(o=t.success,r=t.error),n.aggregate(e,function(t,n){t===TO_DELETE?o(n):F({method:"aggregate",params:e,errorMsg:t.toString()},r)})}catch(i){F({method:"aggregate",params:e,errorMsg:i.toString()},r)}},r.createIndex=_=function(e,t){var o,r;try{void 0!==t&&(CHECK_IS_DATA(t)!==!0?o=t:(o=t.success,r=t.error)),n.ensureIndex(e,{safe:!0},function(t){t===TO_DELETE?void 0!==o&&o():F({method:"createIndex",keys:e,errorMsg:t.toString()},r)})}catch(i){F({method:"createIndex",keys:e,errorMsg:i.toString()},r)}},r.removeIndex=m=function(e,t){var o,r;try{void 0!==t&&(CHECK_IS_DATA(t)!==!0?o=t:(o=t.success,r=t.error)),n.dropIndex(e,{safe:!0},function(t){t===TO_DELETE?void 0!==o&&o():F({method:"removeIndex",index:e,errorMsg:t.toString()},r)})}catch(i){F({method:"removeIndex",index:e,errorMsg:i.toString()},r)}},r.findAllIndexes=S=function(e){var t,o;try{CHECK_IS_DATA(e)!==!0?t=e:(t=e.success,o=e.error),n.indexInformation(function(e,r){var n;e===TO_DELETE?(n=[],EACH(r,function(e){var t={};EACH(e,function(e){t[e[0]]=e[1]}),n.push(t)}),t(n)):F({method:"findAllIndexes",errorMsg:e.toString()},o)})}catch(r){F({method:"findAllIndexes",errorMsg:r.toString()},o)}},EACH(C,function(e){s(e.data,e.callbackOrHandlers)}),C=void 0,EACH(T,function(e){d(e.idOrParams,e.callbackOrHandlers)}),T=void 0,EACH(O,function(e){E(e.data,e.callbackOrHandlers)}),O=void 0,EACH(g,function(e){u(e.id,e.callbackOrHandlers)}),g=void 0,EACH(I,function(e){l(e.params,e.callbackOrHandlers)}),I=void 0,EACH(h,function(e){f(e.params,e.callbackOrHandlers)}),h=void 0,EACH(D,function(e){v(e.params,e.callbackOrHandlers)}),D=void 0,EACH(H,function(e){A(e.params,e.callbackOrHandlers)}),H=void 0,EACH(R,function(e){_(e.keys,e.callbackOrHandlers)}),R=void 0,EACH(p,function(e){m(e.index,e.callbackOrHandlers)}),p=void 0})}})});FOR_BOX(function(n){"use strict";n.LOG_DB=CLASS({init:function(i,t,o){var c,u=[];t.log=c=function(n){u.push(n)},CONNECT_TO_DB_SERVER.addInitDBFunc(function(i){var e=i.collection(n.boxName+"."+o);t.log=c=function(n){n.time=new Date,e.insert(n,{w:0})},EACH(u,function(n){c(n)}),u=void 0})}})});OVERRIDE(NODE_CONFIG,function(O){global.NODE_CONFIG=COMBINE([O,{isDBLogMode:!1,maxDataCount:1e3}])});