global.CONNECT_TO_DB_SERVER=METHOD(function(o){var n,i,t=[];return o.addInitDBFunc=i=function(o){void 0===n?t.push(o):o(n)},{run:function(o,i){"use strict";var E=o.username,r=o.password,d=void 0===o.host?"127.0.0.1":o.host,u=void 0===o.port?27017:o.port,c=o.name;require("mongodb").MongoClient.connect("mongodb://"+(void 0!==E&&void 0!==r?E+":"+r+"@":"")+d+":"+u+"/"+c,function(o,E){o!==TO_DELETE?console.log(CONSOLE_RED("[UPPERCASE.IO-DB] CONNECT TO DB SERVER FAILED: "+o.toString())):(n=E,EACH(t,function(o){o(n)}),t=void 0,void 0!==i&&i())})}}});FOR_BOX(function(o){"use strict";var r=require("mongodb").ObjectID;o.DB=CLASS({init:function(e,t,n){var i,a,c,d,s,E,u,l,f,_,v,O,m,A,g=[],C=[],T=[],S=[],D=[],H=[],I=[],h=[],x=[],p=[],N=[],L=function(o){return a===!0?o:VALID.id(o)===!0?new r(o):-1},M=function(o){return void 0!==o._id&&(o.id=o._id.toString()),delete o._id,delete o.__RANDOM_KEY,o},b=function(o){EACH(o,function(r,e){void 0===r||r===TO_DELETE?REMOVE({data:o,name:e}):(CHECK_IS_DATA(r)===!0||CHECK_IS_ARRAY(r)===!0)&&b(r)})},R=function(o){var r=function(o){void 0!==o.id&&(CHECK_IS_DATA(o.id)===!0?(EACH(o.id,function(r,e){CHECK_IS_DATA(r)===!0||CHECK_IS_ARRAY(r)===!0?EACH(r,function(o,e){r[e]=L(o)}):o.id[e]=L(r)}),o._id=o.id):o._id=L(o.id),delete o.id),EACH(o,function(r,e){void 0===r&&delete o[e]})};void 0!==o.$and?EACH(o.$and,function(o){r(o)}):void 0!==o.$or?EACH(o.$or,function(o){r(o)}):r(o)};CHECK_IS_DATA(n)!==!0?i=n:(i=n.name,a=n.isNotUsingObjectId,c=n.isNotUsingHistory),t.create=d=function(o,r){g.push({data:o,callbackOrHandlers:r})},t.get=s=function(o,r){C.push({idOrParams:o,callbackOrHandlers:r})},t.update=E=function(o,r){T.push({data:o,callbackOrHandlers:r})},a!==!0&&(t.remove=u=function(o,r){S.push({id:o,callbackOrHandlers:r})}),t.find=l=function(o,r){D.push({params:o,callbackOrHandlers:r})},t.count=f=function(o,r){H.push({params:o,callbackOrHandlers:r})},t.checkIsExists=_=function(o,r){I.push({params:o,callbackOrHandlers:r})},t.aggregate=v=function(o,r){h.push({params:o,callbackOrHandlers:r})},t.createIndex=O=function(o,r){x.push({keys:o,callbackOrHandlers:r})},t.removeIndex=m=function(o,r){p.push({index:o,callbackOrHandlers:r})},t.findAllIndexes=A=function(o){N.push({callbackOrHandlers:o})},CONNECT_TO_DB_SERVER.addInitDBFunc(function(r){var e,n=r.collection(o.boxName+"."+i),N=r.collection(o.boxName+"."+i+"__HISTORY"),k=r.collection(o.boxName+"."+i+"__ERROR"),K=function(r,e,t,n){N.findOne({_id:e},function(o,i){var a;o===TO_DELETE&&(a={method:r,time:n},void 0!==t&&(a.change=t),i===TO_DELETE?N.insert({_id:e,timeline:[a]},{w:0}):N.update({_id:e},{$push:{timeline:a}},{w:0}))}),NODE_CONFIG.isDBLogMode===!0&&("remove"===r?console.log("[UPPERCASE.IO-DB] `"+o.boxName+"."+i+"` DATA("+e+") REMOVED."):console.log("[UPPERCASE.IO-DB] `"+o.boxName+"."+i+"` DATA("+e+") SAVED:",t))},y=function(r,e){r.time=new Date;try{k.insert(r,{w:0})}catch(t){}void 0!==e?e(r.errorMsg):console.log("[UPPERCASE.IO-DB] `"+o.boxName+"."+i+"` ERROR:",r)};t.create=d=function(o,r){var e,t;try{o.__RANDOM_KEY=Math.random(),o.createTime=new Date,b(o),delete o._id,a===!0&&(o._id=o.id),delete o.id,void 0!==r&&(CHECK_IS_DATA(r)!==!0?e=r:(e=r.success,t=r.error)),n.insert(o,{safe:!0},function(r,n){var i;r===TO_DELETE?(i=n[0],M(i),c!==!0&&K("create",i.id,i,i.createTime),void 0!==e&&e(i)):y({method:"create",data:o,errorMsg:r.toString()},t)})}catch(i){y({method:"create",data:o,errorMsg:i.toString()},t)}},e=function(r,e){var t,a,c,d=r.filter,s=r.sort;try{R(d),CHECK_IS_DATA(e)!==!0?t=e:(t=e.success,a=e.notExists,c=e.error),n.find(d).sort(s).limit(1).toArray(function(e,n){var s;e===TO_DELETE?n!==TO_DELETE&&n.length>0?(s=n[0],M(s),t(s)):void 0!==a?a():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+o.boxName+"."+i+".get` NOT EXISTS."),d):y({method:"get",params:r,errorMsg:e.toString()},c)})}catch(E){y({method:"get",params:r,errorMsg:E.toString()},c)}},t.get=s=function(o,r){var t,n,i,a,c,d,s,E;try{CHECK_IS_DATA(o)!==!0?t=o:(t=o.id,n=o.filter,i=o.sort,a=o.isRandom),CHECK_IS_DATA(r)!==!0?c=r:(c=r.success,d=r.notExists,s=r.error),void 0===i&&(i={createTime:-1}),a===!0?(void 0===n&&(n={}),n.__RANDOM_KEY={$gte:E=Math.random()},i.__RANDOM_KEY=1,e({filter:n,sort:i},{error:s,notExists:function(){n.__RANDOM_KEY={$lte:E},e({filter:n,sort:i},r)},success:c})):(void 0===n&&(n={_id:L(t)}),e({filter:n,sort:i},r))}catch(u){y({method:"get",idOrParams:o,errorMsg:u.toString()},s)}},t.update=E=function(r,e){var t,a,d,E,u,l,f,_=r.id,v=r.$inc;try{a={_id:L(_)},void 0!==e&&(CHECK_IS_DATA(e)!==!0?d=e:(d=e.success,E=e.notExists,u=e.error)),EACH(r,function(o,e){"id"===e||"_id"===e||"createTime"===e||"$inc"===e?delete r[e]:o===TO_DELETE?(void 0===t&&(t={}),t[e]=""):f=!0}),r.lastUpdateTime=new Date,b(r),l={$set:r},void 0!==t&&(l.$unset=t),void 0!==v&&(l.$inc=v),n.update(a,l,{safe:!0},function(e,n){0===n?void 0!==E?E():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+o.boxName+"."+i+".update` NOT EXISTS."),a):e===TO_DELETE?s({filter:a},{error:function(o){y({method:"update",data:r,errorMsg:o},u)},notExists:function(){void 0!==E?E():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+o.boxName+"."+i+".update` NOT EXISTS."),a)},success:function(o){var e;(void 0===v||f===!0||void 0!==t)&&(e={},f===!0&&EACH(r,function(o,r){e[r]=o}),void 0!==t&&EACH(t,function(o,r){e[r]=TO_DELETE}),c!==!0&&K("update",_,e,o.lastUpdateTime)),M(o),void 0!==d&&d(o)}}):y({method:"update",data:r,errorMsg:e.toString()},u)})}catch(O){y({method:"update",data:r,errorMsg:O.toString()},u)}},a!==!0&&(t.remove=u=function(r,e){var t,a,d,E;try{t={_id:L(r)},void 0!==e&&(CHECK_IS_DATA(e)!==!0?a=e:(a=e.success,d=e.notExists,E=e.error)),s({filter:t},{error:function(o){y({method:"remove",id:r,errorMsg:o},E)},notExists:function(){void 0!==d?d():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+o.boxName+"."+i+".remove` NOT EXISTS."),t)},success:function(e){n.remove(t,{safe:!0},function(n,s){0===s?void 0!==d?d():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+o.boxName+"."+i+".remove` NOT EXISTS."),t):n===TO_DELETE?(c!==!0&&K("remove",r,void 0,new Date),M(e),void 0!==a&&a(e)):y({method:"remove",id:r,errorMsg:n.toString()},E)})}})}catch(u){y({method:"remove",id:r,errorMsg:u.toString()},E)}}),t.find=l=function(o,r){var e,t,i,a,c,d,s,E;try{void 0===r&&(r=o,o=void 0),void 0!==o&&(e=o.filter,t=o.sort,i=INTEGER(o.start),a=INTEGER(o.count),c=o.isFindAll),CHECK_IS_DATA(r)!==!0?d=r:(d=r.success,s=r.error),void 0===e&&(e={}),void 0===t&&(t={createTime:-1}),void 0===i&&(i=0),c!==!0&&(void 0===a||a>NODE_CONFIG.maxDataCount||isNaN(a)===!0?a=NODE_CONFIG.maxDataCount:1>a&&(a=1)),R(e),E=function(r,e){r===TO_DELETE?(e!==TO_DELETE&&EACH(e,function(o){M(o)}),d(e)):y({method:"find",params:o,errorMsg:r.toString()},s)},c===!0?n.find(e).sort(t).skip(i).toArray(E):n.find(e).sort(t).skip(i).limit(a).toArray(E)}catch(u){y({method:"find",params:o,errorMsg:u.toString()},s)}},t.count=f=function(o,r){var e,t,i;try{void 0===r&&(r=o,o=void 0),void 0!==o&&(e=o.filter),void 0===r&&(r=e,e=void 0),void 0===e&&(e={}),CHECK_IS_DATA(r)!==!0?t=r:(t=r.success,i=r.error),R(e),n.find(e).count(function(o,r){o===TO_DELETE?t(r):y({method:"count",filter:e,errorMsg:o.toString()},i)})}catch(a){y({method:"count",filter:e,errorMsg:a.toString()},i)}},t.checkIsExists=_=function(o,r){var e,t,i;try{void 0===r&&(r=o,o=void 0),void 0!==o&&(e=o.filter),void 0===r&&(r=e,e=void 0),void 0===e?e={}:CHECK_IS_DATA(e)!==!0&&(e={_id:L(e)}),CHECK_IS_DATA(r)!==!0?t=r:(t=r.success,i=r.error),R(e),n.find(e).count(function(o,r){o===TO_DELETE?t(void 0!==r&&r>0):y({method:"checkIsExists",filter:e,errorMsg:o.toString()},i)})}catch(a){y({method:"checkIsExists",filter:e,errorMsg:a.toString()},i)}},t.aggregate=v=function(o,r){var e,t;try{CHECK_IS_DATA(r)!==!0?e=r:(e=r.success,t=r.error),n.aggregate(o,function(r,n){r===TO_DELETE?e(n):y({method:"aggregate",params:o,errorMsg:r.toString()},t)})}catch(i){y({method:"aggregate",params:o,errorMsg:i.toString()},t)}},t.createIndex=O=function(o,r){var e,t;try{void 0!==r&&(CHECK_IS_DATA(r)!==!0?e=r:(e=r.success,t=r.error)),n.ensureIndex(o,{safe:!0},function(r){r===TO_DELETE?void 0!==e&&e():y({method:"createIndex",keys:o,errorMsg:r.toString()},t)})}catch(i){y({method:"createIndex",keys:o,errorMsg:i.toString()},t)}},t.removeIndex=m=function(o,r){var e,t;try{void 0!==r&&(CHECK_IS_DATA(r)!==!0?e=r:(e=r.success,t=r.error)),n.dropIndex(o,{safe:!0},function(r){r===TO_DELETE?void 0!==e&&e():y({method:"removeIndex",index:o,errorMsg:r.toString()},t)})}catch(i){y({method:"removeIndex",index:o,errorMsg:i.toString()},t)}},t.findAllIndexes=A=function(o){var r,e;try{CHECK_IS_DATA(o)!==!0?r=o:(r=o.success,e=o.error),n.indexInformation(function(o,t){var n;o===TO_DELETE?(n=[],EACH(t,function(o){var r={};EACH(o,function(o){r[o[0]]=o[1]}),n.push(r)}),r(n)):y({method:"findAllIndexes",errorMsg:o.toString()},e)})}catch(t){y({method:"findAllIndexes",errorMsg:t.toString()},e)}},EACH(g,function(o){d(o.data,o.callbackOrHandlers)}),g=void 0,EACH(C,function(o){s(o.idOrParams,o.callbackOrHandlers)}),C=void 0,EACH(T,function(o){E(o.data,o.callbackOrHandlers)}),T=void 0,EACH(S,function(o){u(o.id,o.callbackOrHandlers)}),S=void 0,EACH(D,function(o){l(o.params,o.callbackOrHandlers)}),D=void 0,EACH(H,function(o){f(o.params,o.callbackOrHandlers)}),H=void 0,EACH(I,function(o){_(o.params,o.callbackOrHandlers)}),I=void 0,EACH(h,function(o){v(o.params,o.callbackOrHandlers)}),h=void 0,EACH(x,function(o){O(o.keys,o.callbackOrHandlers)}),x=void 0,EACH(p,function(o){m(o.index,o.callbackOrHandlers)}),p=void 0})}})});FOR_BOX(function(n){"use strict";n.LOG_DB=CLASS({init:function(i,t,o){var c,u=[];t.log=c=function(n){u.push(n)},CONNECT_TO_DB_SERVER.addInitDBFunc(function(i){var e=i.collection(n.boxName+"."+o);t.log=c=function(n){n.time=new Date,e.insert(n,{w:0})},EACH(u,function(n){c(n)}),u=void 0})}})});OVERRIDE(NODE_CONFIG,function(O){global.NODE_CONFIG=COMBINE([O,{isDBLogMode:!1,maxDataCount:1e3}])});