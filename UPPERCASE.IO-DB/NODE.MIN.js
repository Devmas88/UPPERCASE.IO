global.CONNECT_TO_DB_SERVER=METHOD(function(o){var n,i,t=[];return o.addInitDBFunc=i=function(o){void 0===n?t.push(o):o(n)},{run:function(o,i){"use strict";var E=o.username,r=o.password,d=void 0===o.host?"127.0.0.1":o.host,u=void 0===o.port?27017:o.port,c=o.name;require("mongodb").MongoClient.connect("mongodb://"+(void 0!==E&&void 0!==r?E+":"+r+"@":"")+d+":"+u+"/"+c,function(o,E){o!==TO_DELETE?console.log(CONSOLE_RED("[UPPERCASE.IO-DB] CONNECT TO DB SERVER FAILED: "+o.toString())):(n=E,EACH(t,function(o){o(n)}),t=void 0,void 0!==i&&i())})}}});FOR_BOX(function(t){"use strict";var o=require("mongodb").ObjectID;t.DB=CLASS({init:function(r,e,i){var n,a,c,d,s,E,u,l,_,f,O,v=[],m=[],A=[],g=[],C=[],T=[],S=[],D=[],H=function(t){return a===!0?t:VALID.id(t)===!0?new o(t):-1},h=function(t){return void 0!==t._id&&(t.id=t._id.toString()),delete t._id,delete t.__RANDOM_KEY,t},I=function(t){EACH(t,function(o,r){void 0===o||o===TO_DELETE?REMOVE({data:t,name:r}):(CHECK_IS_DATA(o)===!0||CHECK_IS_ARRAY(o)===!0)&&I(o)})},N=function(t){var o=function(t){void 0!==t.id&&(CHECK_IS_DATA(t.id)===!0?(EACH(t.id,function(o,r){CHECK_IS_DATA(o)===!0||CHECK_IS_ARRAY(o)===!0?EACH(o,function(t,r){o[r]=H(t)}):t.id[r]=H(o)}),t._id=t.id):t._id=H(t.id),delete t.id),EACH(t,function(o,r){void 0===o&&delete t[r]})};void 0!==t.$and?EACH(t.$and,function(t){o(t)}):void 0!==t.$or?EACH(t.$or,function(t){o(t)}):o(t)};CHECK_IS_DATA(i)!==!0?n=i:(n=i.name,a=i.isNotUsingObjectId,c=i.isNotUsingHistory),e.create=d=function(t,o){v.push({data:t,callbackOrHandlers:o})},e.get=s=function(t,o){m.push({idOrParams:t,callbackOrHandlers:o})},e.update=E=function(t,o){A.push({data:t,callbackOrHandlers:o})},a!==!0&&(e.remove=u=function(t,o){g.push({id:t,callbackOrHandlers:o})}),e.find=l=function(t,o){C.push({params:t,callbackOrHandlers:o})},e.count=_=function(t,o){T.push({params:t,callbackOrHandlers:o})},e.checkIsExists=f=function(t,o){S.push({params:t,callbackOrHandlers:o})},e.aggregate=O=function(t,o){D.push({params:t,callbackOrHandlers:o})},CONNECT_TO_DB_SERVER.addInitDBFunc(function(o){var r,i=o.collection(t.boxName+"."+n),p=o.collection(t.boxName+"."+n+"__HISTORY"),L=o.collection(t.boxName+"."+n+"__ERROR"),R=function(o,r,e,i){p.findOne({id:r},function(t,n){var a;t===TO_DELETE&&(a={method:o,time:i},void 0!==e&&(a.change=e),n===TO_DELETE?p.insert({id:r,timeline:[a]},{w:0}):p.update({id:r},{$push:{timeline:a}},{w:0}))}),NODE_CONFIG.isDBLogMode===!0&&("remove"===o?console.log("[UPPERCASE.IO-DB] `"+t.boxName+"."+n+"` DATA("+r+") REMOVED."):console.log("[UPPERCASE.IO-DB] `"+t.boxName+"."+n+"` DATA("+r+") SAVED:",e))},b=function(o,r){o.time=new Date;try{L.insert(o,{w:0})}catch(e){}void 0!==r?r(o.errorMsg):console.log("[UPPERCASE.IO-DB] `"+t.boxName+"."+n+"` ERROR:",o)};e.create=d=function(t,o){var r,e;try{t.__RANDOM_KEY=Math.random(),t.createTime=new Date,I(t),delete t._id,a===!0&&(t._id=t.id),delete t.id,void 0!==o&&(CHECK_IS_DATA(o)!==!0?r=o:(r=o.success,e=o.error)),i.insert(t,{safe:!0},function(o,i){var n;o===TO_DELETE?(n=i[0],h(n),c!==!0&&R("create",n.id,n,n.createTime),void 0!==r&&r(n)):b({method:"create",data:t,errorMsg:o.toString()},e)})}catch(n){b({method:"create",data:t,errorMsg:n.toString()},e)}},r=function(o,r){var e,a,c,d=o.filter,s=o.sort;try{N(d),CHECK_IS_DATA(r)!==!0?e=r:(e=r.success,a=r.notExists,c=r.error),i.find(d).sort(s).limit(1).toArray(function(r,i){var s;r===TO_DELETE?i!==TO_DELETE&&i.length>0?(s=i[0],h(s),e(s)):void 0!==a?a():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+t.boxName+"."+n+".get` NOT EXISTS."),d):b({method:"get",params:o,errorMsg:r.toString()},c)})}catch(E){b({method:"get",params:o,errorMsg:E.toString()},c)}},e.get=s=function(t,o){var e,i,n,a,c,d,s,E;try{CHECK_IS_DATA(t)!==!0?e=t:(e=t.id,i=t.filter,n=t.sort,a=t.isRandom),CHECK_IS_DATA(o)!==!0?c=o:(c=o.success,d=o.notExists,s=o.error),void 0===n&&(n={createTime:-1}),a===!0?(void 0===i&&(i={}),i.__RANDOM_KEY={$gte:E=Math.random()},n.__RANDOM_KEY=1,r({filter:i,sort:n},{error:s,notExists:function(){i.__RANDOM_KEY={$lte:E},r({filter:i,sort:n},o)},success:c})):(void 0===i&&(i={_id:H(e)}),r({filter:i,sort:n},o))}catch(u){b({method:"get",idOrParams:t,errorMsg:u.toString()},s)}},e.update=E=function(o,r){var e,a,d,E,u,l,_,f=o.id,O=o.$inc;try{a={_id:H(f)},void 0!==r&&(CHECK_IS_DATA(r)!==!0?d=r:(d=r.success,E=r.notExists,u=r.error)),EACH(o,function(t,r){"id"===r||"_id"===r||"createTime"===r||"$inc"===r?delete o[r]:t===TO_DELETE?(void 0===e&&(e={}),e[r]=""):_=!0}),o.lastUpdateTime=new Date,I(o),l={$set:o},void 0!==e&&(l.$unset=e),void 0!==O&&(l.$inc=O),i.update(a,l,{safe:!0},function(r,i){0===i?void 0!==E?E():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+t.boxName+"."+n+".update` NOT EXISTS."),a):r===TO_DELETE?s({filter:a},{error:function(t){b({method:"update",data:o,errorMsg:t},u)},notExists:function(){void 0!==E?E():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+t.boxName+"."+n+".update` NOT EXISTS."),a)},success:function(t){var r;(void 0===O||_===!0||void 0!==e)&&(r={},_===!0&&EACH(o,function(t,o){r[o]=t}),void 0!==e&&EACH(e,function(t,o){r[o]=TO_DELETE}),c!==!0&&R("update",f,r,t.lastUpdateTime)),h(t),void 0!==d&&d(t)}}):b({method:"update",data:o,errorMsg:r.toString()},u)})}catch(v){b({method:"update",data:o,errorMsg:v.toString()},u)}},a!==!0&&(e.remove=u=function(o,r){var e,a,d,E;try{e={_id:H(o)},void 0!==r&&(CHECK_IS_DATA(r)!==!0?a=r:(a=r.success,d=r.notExists,E=r.error)),s({filter:e},{error:function(t){b({method:"remove",id:o,errorMsg:t},E)},notExists:function(){void 0!==d?d():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+t.boxName+"."+n+".remove` NOT EXISTS."),e)},success:function(r){i.remove(e,{safe:!0},function(i,s){0===s?void 0!==d?d():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+t.boxName+"."+n+".remove` NOT EXISTS."),e):i===TO_DELETE?(c!==!0&&R("remove",o,void 0,new Date),h(r),void 0!==a&&a(r)):b({method:"remove",id:o,errorMsg:i.toString()},E)})}})}catch(u){b({method:"remove",id:o,errorMsg:u.toString()},E)}}),e.find=l=function(t,o){var r,e,n,a,c,d,s,E;try{void 0===o&&(o=t,t=void 0),void 0!==t&&(r=t.filter,e=t.sort,n=INTEGER(t.start),a=INTEGER(t.count),c=t.isFindAll),CHECK_IS_DATA(o)!==!0?d=o:(d=o.success,s=o.error),void 0===r&&(r={}),void 0===e&&(e={createTime:-1}),void 0===n&&(n=0),c!==!0&&(void 0===a||a>NODE_CONFIG.maxDataCount||isNaN(a)===!0?a=NODE_CONFIG.maxDataCount:1>a&&(a=1)),N(r),E=function(o,r){o===TO_DELETE?(r!==TO_DELETE&&EACH(r,function(t){h(t)}),d(r)):b({method:"find",params:t,errorMsg:o.toString()},s)},c===!0?i.find(r).sort(e).skip(n).toArray(E):i.find(r).sort(e).skip(n).limit(a).toArray(E)}catch(u){b({method:"find",params:t,errorMsg:u.toString()},s)}},e.count=_=function(t,o){var r,e,n;try{void 0===o&&(o=t,t=void 0),void 0!==t&&(r=t.filter),void 0===o&&(o=r,r=void 0),void 0===r&&(r={}),CHECK_IS_DATA(o)!==!0?e=o:(e=o.success,n=o.error),N(r),i.find(r).count(function(t,o){t===TO_DELETE?e(o):b({method:"count",filter:r,errorMsg:t.toString()},n)})}catch(a){b({method:"count",filter:r,errorMsg:a.toString()},n)}},e.checkIsExists=f=function(t,o){var r,e,n;try{void 0===o&&(o=t,t=void 0),void 0!==t&&(r=t.filter),void 0===o&&(o=r,r=void 0),void 0===r?r={}:CHECK_IS_DATA(r)!==!0&&(r={_id:H(r)}),CHECK_IS_DATA(o)!==!0?e=o:(e=o.success,n=o.error),N(r),i.find(r).count(function(t,o){t===TO_DELETE?e(void 0!==o&&o>0):b({method:"checkIsExists",filter:r,errorMsg:t.toString()},n)})}catch(a){b({method:"checkIsExists",filter:r,errorMsg:a.toString()},n)}},e.aggregate=O=function(t,o){var r,e;try{CHECK_IS_DATA(o)!==!0?r=o:(r=o.success,e=o.error),i.aggregate(t,function(o,i){o===TO_DELETE?r(i):b({method:"aggregate",params:t,errorMsg:o.toString()},e)})}catch(n){b({method:"aggregate",params:t,errorMsg:n.toString()},e)}},EACH(v,function(t){d(t.data,t.callbackOrHandlers)}),v=void 0,EACH(m,function(t){s(t.idOrParams,t.callbackOrHandlers)}),m=void 0,EACH(A,function(t){E(t.data,t.callbackOrHandlers)}),A=void 0,EACH(g,function(t){u(t.id,t.callbackOrHandlers)}),g=void 0,EACH(C,function(t){l(t.params,t.callbackOrHandlers)}),C=void 0,EACH(T,function(t){_(t.params,t.callbackOrHandlers)}),T=void 0,EACH(S,function(t){f(t.params,t.callbackOrHandlers)}),S=void 0,EACH(D,function(t){O(t.params,t.callbackOrHandlers)}),D=void 0})}})});FOR_BOX(function(n){"use strict";n.LOG_DB=CLASS({init:function(i,t,o){var c,u=[];t.log=c=function(n){u.push(n)},CONNECT_TO_DB_SERVER.addInitDBFunc(function(i){var e=i.collection(n.boxName+"."+o);t.log=c=function(n){n.time=new Date,e.insert(n,{w:0})},EACH(u,function(n){c(n)}),u=void 0})}})});OVERRIDE(NODE_CONFIG,function(O){global.NODE_CONFIG=COMBINE([O,{isDBLogMode:!1,maxDataCount:1e3}])});