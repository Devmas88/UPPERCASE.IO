global.CONNECT_TO_DB_SERVER=CONNECT_TO_DB_SERVER=METHOD(function(t){var o,i,e=[];return t.addInitDBFunc=i=function(t){void 0===o?e.push(t):t(o)},{run:function(t,i){"use strict";var r=t.username,n=t.password,a=void 0===t.host?"127.0.0.1":t.host,d=void 0===t.port?27017:t.port,c=t.name;require("mongodb").MongoClient.connect("mongodb://"+(void 0!==r&&void 0!==n?r+":"+n+"@":"")+a+":"+d+"/"+c,function(t,r){t!==TO_DELETE?console.log(CONSOLE_RED("[UPPERCASE.IO-DB] CONNECT TO DB SERVER FAILED: "+t.toString())):(o=r,EACH(e,function(t){t(o)}),e=void 0,void 0!==i&&i())})}}}),FOR_BOX(function(t){"use strict";var o=require("mongodb").ObjectID,i=function(t){return new o(t)},e=function(t){return void 0!==t._id&&(t.id=t._id.toString()),delete t._id,delete t.__IS_ENABLED,delete t.__RANDOM_KEY,t},r=function(t){EACH(t,function(o,i){o===TO_DELETE?REMOVE({data:t,name:i}):(CHECK_IS_DATA(o)===!0||CHECK_IS_ARRAY(o)===!0)&&r(o)})},n=function(t,o){var e=function(t){void 0!==t.id&&(CHECK_IS_DATA(t.id)===!0?(EACH(t.id,function(o,e){CHECK_IS_DATA(o)===!0||CHECK_IS_ARRAY(o)===!0?EACH(o,function(t,e){o[e]=i(t)}):t.id[e]=i(o)}),t._id=t.id):t._id=i(id),delete t.id),o!==!0&&(t.__IS_ENABLED=!0),EACH(t,function(o,i){void 0===o&&delete t[i]})};void 0!==t.$and?EACH(t.$and,function(t){e(t)}):void 0!==t.$or?EACH(t.$or,function(t){e(t)}):e(t)};t.DB=CLASS({init:function(o,a,d){var c,s,E,u,_,l,f,v=[],D=[],m=[],O=[],C=[],A=[],T=[];a.create=c=function(t,o){v.push({data:t,callbackOrHandlers:o})},a.get=s=function(t,o){D.push({idOrParams:t,callbackOrHandlers:o})},a.update=E=function(t,o){m.push({data:t,callbackOrHandlers:o})},a.remove=u=function(t,o){O.push({idOrParams:t,callbackOrHandlers:o})},a.find=_=function(t,o){C.push({params:t,callbackOrHandlers:o})},a.count=l=function(t,o){A.push({filterOrParams:t,callbackOrHandlers:o})},a.checkIsExists=f=function(t,o){T.push({filterOrParams:t,callbackOrHandlers:o})},CONNECT_TO_DB_SERVER.addInitDBFunc(function(o){var S,g=o.collection(t.boxName+"."+d),I=o.collection(t.boxName+"."+d+"__HISTORY"),H=o.collection(t.boxName+"."+d+"__ERROR"),R=function(o,i,e,r){I.findOne({id:i},function(t,n){var a;t===TO_DELETE&&(a={method:o,change:e,time:r},n===TO_DELETE?I.insert({id:i,timeline:[a]},{w:0}):I.update({id:i},{$push:{timeline:a}},{w:0}))}),NODE_CONFIG.isDBLogMode===!0&&console.log("[UPPERCASE.IO-DB] `"+t.boxName+"."+d+"` DATA SAVED:",data)},h=function(o,i){o.time=new Date,H.insert(o,{w:0}),void 0!==i?i(o.errorMsg):console.log("[UPPERCASE.IO-DB] `"+t.boxName+"."+d+"` ERROR:",o)};a.create=c=function(t,o){var i,n;try{t.__IS_ENABLED=!0,t.__RANDOM_KEY=Math.random(),t.createTime=new Date,r(t),void 0!==o&&(CHECK_IS_DATA(o)!==!0?i=o:(i=o.success,n=o.error)),g.insert(t,{safe:!0},function(o,r){var a;o===TO_DELETE?(a=r[0],R("create",a._id.toString(),t,t.createTime),e(a),void 0!==i&&i(a)):h({method:"create",data:t,errorMsg:o.toString()},n)})}catch(a){h({method:"create",data:t,errorMsg:a.toString()},n)}},S=function(t,o){var i,r,a,d=t.filter,c=t.sort,s=t.isIncludeRemovedData;try{n(d,s),CHECK_IS_DATA(o)!==!0?i=o:(i=o.success,r=o.notExists,a=o.error),g.find(d).sort(c).limit(1).toArray(function(o,n){var d;o===TO_DELETE?n!==TO_DELETE&&n.length>0?(d=n[0],e(d),i(d)):void 0!==r&&r():h({method:"get",params:t,errorMsg:o.toString()},a)})}catch(E){h({method:"get",params:t,errorMsg:E.toString()},a)}},a.get=s=function(t,o){var e,r,n,a,d,c,s,E;void 0===o&&(o=t,t=void 0),CHECK_IS_DATA(o)!==!0?d=o:(d=o.success,c=o.notExists,s=o.error);try{CHECK_IS_DATA(t)===!0?(e=t.filter,r=t.sort,n=t.isRandom,a=t.isIncludeRemovedData):void 0!==t&&(e={_id:i(t)}),void 0===e&&(e={}),void 0===r&&(r={createTime:-1}),n===!0?(e.__RANDOM_KEY={$gte:E=Math.random()},r.__RANDOM_KEY=1,S({filter:e,sort:r,isIncludeRemovedData:a},{error:s,notExists:function(){e.__RANDOM_KEY={$lte:E},S({filter:e,sort:r,isIncludeRemovedData:a},o)},success:d})):S({filter:e,sort:r,isIncludeRemovedData:a},o)}catch(u){h({method:"get",idOrParams:t,errorMsg:u.toString()},s)}},a.update=E=function(t,o){var r,n,a,d,c,E,u,_=t.id,l=t.$inc;try{n={_id:i(_),__IS_ENABLED:!0},void 0!==o&&(CHECK_IS_DATA(o)!==!0?a=o:(a=o.success,d=o.notExists,c=o.error)),EACH(t,function(o,i){"id"===i||"_id"===i||"__IS_ENABLED"===i||"createTime"===i||"$inc"===i?delete t[i]:o===TO_DELETE?(void 0===r&&(r={}),r[i]="",delete t[i]):u=!0}),t.lastUpdateTime=new Date,E={$set:t},void 0!==r&&(E.$unset=r),void 0!==l&&(E.$inc=l),g.update(n,E,{safe:!0},function(o,i){0===i?void 0!==d&&d():o===TO_DELETE?s({filter:n},{error:function(o){h({method:"update",data:t,errorMsg:o},c)},notExists:function(){void 0!==d&&d()},success:function(o){var i;(void 0===l||u===!0||void 0!==r)&&(i={},u===!0&&EACH(t,function(t,o){i[o]=t}),void 0!==r&&EACH(r,function(t,o){i[o]=TO_DELETE}),R("update",_,i,t.lastUpdateTime)),e(o),void 0!==a&&a(o)}}):h({method:"update",data:t,errorMsg:o.toString()},c)})}catch(f){h({method:"update",data:t,errorMsg:f.toString()},c)}},a.remove=u=function(t,o){var r,n,a,d,c,E;try{CHECK_IS_DATA(t)!==!0?r=t:(r=t.id,n=t.isRemoveForever),a={_id:i(r),__IS_ENABLED:!0},void 0!==o&&(CHECK_IS_DATA(o)!==!0?d=o:(d=o.success,c=o.notExists,E=o.error)),s({filter:a},{error:function(t){h({method:"remove",id:r,errorMsg:t},E)},notExists:function(){void 0!==c&&c()},success:function(t){var o;g.update(a,{$set:o={__IS_ENABLED:!1,removeTime:new Date}},{safe:!0},function(i,n){0===n?void 0!==c&&c():i===TO_DELETE?(R("remove",t.id,o,o.removeTime),e(t),void 0!==d&&d(t)):h({method:"remove",id:r,errorMsg:i.toString()},E)})}})}catch(u){h({method:"remove",id:r,errorMsg:u.toString()},E)}},a.find=_=function(t,o){var i,r,a,d,c,s,E,u,_;try{void 0===o&&(o=t,t=void 0),void 0!==t&&(i=t.filter,r=t.sort,a=INTEGER(t.start),d=INTEGER(t.count),c=t.isFindAll,s=t.isIncludeRemovedData),CHECK_IS_DATA(o)!==!0?E=o:(E=o.success,u=o.error),void 0===i&&(i={}),void 0===r&&(r={createTime:-1}),void 0===a&&(a=0),c!==!0&&(void 0===d||d>NODE_CONFIG.maxDataCount||isNaN(d)===!0?d=NODE_CONFIG.maxDataCount:1>d&&(d=1)),n(i),_=function(o,i){o===TO_DELETE?(i!==TO_DELETE&&EACH(i,function(t){e(t)}),E(i)):h({method:"find",params:t,errorMsg:o.toString()},u)},c===!0?g.find(i).sort(r).skip(a).toArray(_):g.find(i).sort(r).skip(a).limit(d).toArray(_)}catch(l){h({method:"find",params:t,errorMsg:l.toString()},u)}},a.count=l=function(t,o){var i,e,r,a;try{CHECK_IS_DATA(t)!==!0?i=t:(i=t.filter,e=t.isIncludeRemovedData),void 0===o&&(o=i,i=void 0),void 0===i&&(i={}),CHECK_IS_DATA(o)!==!0?r=o:(r=o.success,a=o.error),n(i),g.find(i).count(function(t,o){t===TO_DELETE?r(o):h({method:"count",filter:i,errorMsg:t.toString()},a)})}catch(d){h({method:"count",filter:i,errorMsg:d.toString()},a)}},a.checkIsExists=f=function(t,o){var e,r,a,d;try{CHECK_IS_DATA(t)!==!0?e=t:(e=t.filter,r=t.isIncludeRemovedData),void 0===o&&(o=e,e=void 0),void 0===e?e={}:CHECK_IS_DATA(e)!==!0&&(e={_id:i(e)}),CHECK_IS_DATA(o)!==!0?a=o:(a=o.success,d=o.error),n(e),g.find(e).count(function(t,o){t===TO_DELETE?a(void 0!==o&&o>0):h({method:"checkIsExists",filter:e,errorMsg:t.toString()},d)})}catch(c){h({method:"checkIsExists",filter:e,errorMsg:c.toString()},d)}},EACH(v,function(t){c(t.data,t.callbackOrHandlers)}),v=void 0,EACH(D,function(t){s(t.idOrParams,t.callbackOrHandlers)}),D=void 0,EACH(m,function(t){E(t.data,t.callbackOrHandlers)}),m=void 0,EACH(O,function(t){u(t.idOrParams,t.callbackOrHandlers)}),O=void 0,EACH(C,function(t){_(t.params,t.callbackOrHandlers)}),C=void 0,EACH(A,function(t){l(t.filterOrParams,t.callbackOrHandlers)}),A=void 0,EACH(T,function(t){f(t.filterOrParams,t.callbackOrHandlers)}),T=void 0})}})}),FOR_BOX(function(t){"use strict";t.LOG_DB=CLASS({init:function(o,i,e){var r,n=[];i.log=r=function(t){n.push(t)},CONNECT_TO_DB_SERVER.addInitDBFunc(function(o){var a=o.collection(t.boxName+"."+e);i.log=r=function(t){t.time=new Date,a.insert(t,{w:0})},EACH(n,function(t){r(t)}),n=void 0})}})}),OVERRIDE(NODE_CONFIG,function(t){global.NODE_CONFIG=NODE_CONFIG=COMBINE([t,{isDBLogMode:!1,maxDataCount:1e3}])});