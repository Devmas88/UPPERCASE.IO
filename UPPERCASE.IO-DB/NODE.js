global.CONNECT_TO_DB_SERVER=CONNECT_TO_DB_SERVER=METHOD(function(o){var n,E,i=[];return o.addInitDBFunc=E=function(o){void 0===n?i.push(o):o(n)},{run:function(o,E){"use strict";var t=o.username,r=o.password,d=void 0===o.host?"127.0.0.1":o.host,u=void 0===o.port?27017:o.port,O=o.name;require("mongodb").MongoClient.connect("mongodb://"+(void 0!==t&&void 0!==r?t+":"+r+"@":"")+d+":"+u+"/"+O,function(o,t){o!==TO_DELETE?console.log(CONSOLE_RED("[UPPERCASE.IO-DB] CONNECT TO DB SERVER FAILED: "+o.toString())):(n=t,EACH(i,function(o){o(n)}),i=void 0,void 0!==E&&E())})}}});FOR_BOX(function(o){"use strict";var e=require("mongodb").ObjectID,t=function(o){return new e(o)},i=function(o){return void 0!==o._id&&(o.id=o._id.toString()),delete o._id,delete o.__IS_ENABLED,delete o.__RANDOM_KEY,o},r=function(o){EACH(o,function(e,t){void 0===e||e===TO_DELETE?REMOVE({data:o,name:t}):(CHECK_IS_DATA(e)===!0||CHECK_IS_ARRAY(e)===!0)&&r(e)})},n=function(o,e){var i=function(o){void 0!==o.id&&(CHECK_IS_DATA(o.id)===!0?(EACH(o.id,function(e,i){CHECK_IS_DATA(e)===!0||CHECK_IS_ARRAY(e)===!0?EACH(e,function(o,i){e[i]=t(o)}):o.id[i]=t(e)}),o._id=o.id):o._id=t(o.id),delete o.id),e!==!0&&(o.__IS_ENABLED=!0),EACH(o,function(e,t){void 0===e&&delete o[t]})};void 0!==o.$and?EACH(o.$and,function(o){i(o)}):void 0!==o.$or?EACH(o.$or,function(o){i(o)}):i(o)};o.DB=CLASS({init:function(e,d,a){var c,s,E,u,_,l,v,m=[],f=[],O=[],A=[],T=[],C=[],S=[];d.create=c=function(o,e){m.push({data:o,callbackOrHandlers:e})},d.get=s=function(o,e){f.push({idOrParams:o,callbackOrHandlers:e})},d.update=E=function(o,e){O.push({data:o,callbackOrHandlers:e})},d.remove=u=function(o,e){A.push({id:o,callbackOrHandlers:e})},d.find=_=function(o,e){T.push({params:o,callbackOrHandlers:e})},d.count=l=function(o,e){C.push({params:o,callbackOrHandlers:e})},d.checkIsExists=v=function(o,e){S.push({params:o,callbackOrHandlers:e})},CONNECT_TO_DB_SERVER.addInitDBFunc(function(e){var D,I=e.collection(o.boxName+"."+a),g=e.collection(o.boxName+"."+a+"__HISTORY"),H=e.collection(o.boxName+"."+a+"__ERROR"),N=function(e,t,i,r){g.findOne({id:t},function(o,n){var d;o===TO_DELETE&&(d={method:e,change:i,time:r},n===TO_DELETE?g.insert({id:t,timeline:[d]},{w:0}):g.update({id:t},{$push:{timeline:d}},{w:0}))}),NODE_CONFIG.isDBLogMode===!0&&console.log("[UPPERCASE.IO-DB] `"+o.boxName+"."+a+"` DATA SAVED:",i)},h=function(e,t){e.time=new Date,H.insert(e,{w:0}),void 0!==t?t(e.errorMsg):console.log("[UPPERCASE.IO-DB] `"+o.boxName+"."+a+"` ERROR:",e)};d.create=c=function(o,e){var t,n;try{o.__IS_ENABLED=!0,o.__RANDOM_KEY=Math.random(),o.createTime=new Date,r(o),void 0!==e&&(CHECK_IS_DATA(e)!==!0?t=e:(t=e.success,n=e.error)),I.insert(o,{safe:!0},function(e,r){var d;e===TO_DELETE?(d=r[0],i(d),N("create",d.id,d,d.createTime),void 0!==t&&t(d)):h({method:"create",data:o,errorMsg:e.toString()},n)})}catch(d){h({method:"create",data:o,errorMsg:d.toString()},n)}},D=function(e,t){var r,d,c,s=e.filter,E=e.sort,u=e.isIncludeRemoved;try{n(s,u),CHECK_IS_DATA(t)!==!0?r=t:(r=t.success,d=t.notExists,c=t.error),I.find(s).sort(E).limit(1).toArray(function(t,n){var E;t===TO_DELETE?n!==TO_DELETE&&n.length>0?(E=n[0],i(E),r(E)):void 0!==d?d():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+o.boxName+"."+a+".get` NOT EXISTS."),s):h({method:"get",params:e,errorMsg:t.toString()},c)})}catch(_){h({method:"get",params:e,errorMsg:_.toString()},c)}},d.get=s=function(o,e){var i,r,n,d,a,c,s,E,u;try{CHECK_IS_DATA(o)!==!0?i=o:(i=o.id,r=o.filter,n=o.sort,d=o.isRandom,a=o.isIncludeRemoved),CHECK_IS_DATA(e)!==!0?c=e:(c=e.success,s=e.notExists,E=e.error),void 0===n&&(n={createTime:-1}),d===!0?(void 0===r&&(r={}),r.__RANDOM_KEY={$gte:u=Math.random()},n.__RANDOM_KEY=1,D({filter:r,sort:n,isIncludeRemoved:a},{error:E,notExists:function(){r.__RANDOM_KEY={$lte:u},D({filter:r,sort:n,isIncludeRemoved:a},e)},success:c})):(void 0===r&&(r={_id:t(i)}),D({filter:r,sort:n,isIncludeRemoved:a},e))}catch(_){h({method:"get",idOrParams:o,errorMsg:_.toString()},E)}},d.update=E=function(e,n){var d,c,E,u,_,l,v,m=e.id,f=e.$inc;try{c={_id:t(m),__IS_ENABLED:!0},void 0!==n&&(CHECK_IS_DATA(n)!==!0?E=n:(E=n.success,u=n.notExists,_=n.error)),EACH(e,function(o,t){"id"===t||"_id"===t||"__IS_ENABLED"===t||"createTime"===t||"$inc"===t?delete e[t]:o===TO_DELETE?(void 0===d&&(d={}),d[t]=""):v=!0}),e.lastUpdateTime=new Date,r(e),l={$set:e},void 0!==d&&(l.$unset=d),void 0!==f&&(l.$inc=f),I.update(c,l,{safe:!0},function(t,r){0===r?void 0!==u?u():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+o.boxName+"."+a+".update` NOT EXISTS."),c):t===TO_DELETE?s({filter:c},{error:function(o){h({method:"update",data:e,errorMsg:o},_)},notExists:function(){void 0!==u?u():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+o.boxName+"."+a+".update` NOT EXISTS."),c)},success:function(o){var t;(void 0===f||v===!0||void 0!==d)&&(t={},v===!0&&EACH(e,function(o,e){t[e]=o}),void 0!==d&&EACH(d,function(o,e){t[e]=TO_DELETE}),N("update",m,t,o.lastUpdateTime)),i(o),void 0!==E&&E(o)}}):h({method:"update",data:e,errorMsg:t.toString()},_)})}catch(O){h({method:"update",data:e,errorMsg:O.toString()},_)}},d.remove=u=function(e,r){var n,d,c,E;try{n={_id:t(e),__IS_ENABLED:!0},void 0!==r&&(CHECK_IS_DATA(r)!==!0?d=r:(d=r.success,c=r.notExists,E=r.error)),s({filter:n},{error:function(o){h({method:"remove",id:e,errorMsg:o},E)},notExists:function(){void 0!==c?c():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+o.boxName+"."+a+".remove` NOT EXISTS."),n)},success:function(t){var r;I.update(n,{$set:r={__IS_ENABLED:!1,removeTime:new Date}},{safe:!0},function(s,u){0===u?void 0!==c?c():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+o.boxName+"."+a+".remove` NOT EXISTS."),n):s===TO_DELETE?(N("remove",t.id,{removeTime:r.removeTime},r.removeTime),i(t),void 0!==d&&d(t)):h({method:"remove",id:e,errorMsg:s.toString()},E)})}})}catch(u){h({method:"remove",id:e,errorMsg:u.toString()},E)}},d.find=_=function(o,e){var t,r,d,a,c,s,E,u,_;try{void 0===e&&(e=o,o=void 0),void 0!==o&&(t=o.filter,r=o.sort,d=INTEGER(o.start),a=INTEGER(o.count),c=o.isFindAll,s=o.isIncludeRemoved),CHECK_IS_DATA(e)!==!0?E=e:(E=e.success,u=e.error),void 0===t&&(t={}),void 0===r&&(r={createTime:-1}),void 0===d&&(d=0),c!==!0&&(void 0===a||a>NODE_CONFIG.maxDataCount||isNaN(a)===!0?a=NODE_CONFIG.maxDataCount:1>a&&(a=1)),n(t),_=function(e,t){e===TO_DELETE?(t!==TO_DELETE&&EACH(t,function(o){i(o)}),E(t)):h({method:"find",params:o,errorMsg:e.toString()},u)},c===!0?I.find(t).sort(r).skip(d).toArray(_):I.find(t).sort(r).skip(d).limit(a).toArray(_)}catch(l){h({method:"find",params:o,errorMsg:l.toString()},u)}},d.count=l=function(o,e){var t,i,r,d;try{void 0===e&&(e=o,o=void 0),void 0!==o&&(t=o.filter,i=o.isIncludeRemoved),void 0===e&&(e=t,t=void 0),void 0===t&&(t={}),CHECK_IS_DATA(e)!==!0?r=e:(r=e.success,d=e.error),n(t),I.find(t).count(function(o,e){o===TO_DELETE?r(e):h({method:"count",filter:t,errorMsg:o.toString()},d)})}catch(a){h({method:"count",filter:t,errorMsg:a.toString()},d)}},d.checkIsExists=v=function(o,e){var i,r,d,a;try{void 0===e&&(e=o,o=void 0),void 0!==o&&(i=o.filter,r=o.isIncludeRemoved),void 0===e&&(e=i,i=void 0),void 0===i?i={}:CHECK_IS_DATA(i)!==!0&&(i={_id:t(i)}),CHECK_IS_DATA(e)!==!0?d=e:(d=e.success,a=e.error),n(i),I.find(i).count(function(o,e){o===TO_DELETE?d(void 0!==e&&e>0):h({method:"checkIsExists",filter:i,errorMsg:o.toString()},a)})}catch(c){h({method:"checkIsExists",filter:i,errorMsg:c.toString()},a)}},EACH(m,function(o){c(o.data,o.callbackOrHandlers)}),m=void 0,EACH(f,function(o){s(o.idOrParams,o.callbackOrHandlers)}),f=void 0,EACH(O,function(o){E(o.data,o.callbackOrHandlers)}),O=void 0,EACH(A,function(o){u(o.id,o.callbackOrHandlers)}),A=void 0,EACH(T,function(o){_(o.params,o.callbackOrHandlers)}),T=void 0,EACH(C,function(o){l(o.params,o.callbackOrHandlers)}),C=void 0,EACH(S,function(o){v(o.params,o.callbackOrHandlers)}),S=void 0})}})});FOR_BOX(function(n){"use strict";n.LOG_DB=CLASS({init:function(i,t,o){var c,u=[];t.log=c=function(n){u.push(n)},CONNECT_TO_DB_SERVER.addInitDBFunc(function(i){var e=i.collection(n.boxName+"."+o);t.log=c=function(n){n.time=new Date,e.insert(n,{w:0})},EACH(u,function(n){c(n)}),u=void 0})}})});OVERRIDE(NODE_CONFIG,function(O){global.NODE_CONFIG=NODE_CONFIG=COMBINE([O,{isDBLogMode:!1,maxDataCount:1e3}])});