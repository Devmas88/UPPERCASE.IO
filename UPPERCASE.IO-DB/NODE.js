global.CONNECT_TO_DB_SERVER=CONNECT_TO_DB_SERVER=METHOD(function(t){var o,i,r=[];return t.addInitDBFunc=i=function(t){void 0===o?r.push(t):t(o)},{run:function(t,i){"use strict";var n=t.username,e=t.password,a=void 0===t.host?"127.0.0.1":t.host,c=void 0===t.port?27017:t.port,d=t.name;require("mongodb").MongoClient.connect("mongodb://"+(void 0!==n&&void 0!==e?n+":"+e+"@":"")+a+":"+c+"/"+d,function(t,n){t!==TO_DELETE?console.log(CONSOLE_RED("[UPPERCASE.IO-DB] CONNECT TO DB SERVER FAILED: "+t.toString())):(o=n,EACH(r,function(t){t(o)}),r=void 0,void 0!==i&&i())})}}}),FOR_BOX(function(t){"use strict";var o=require("mongodb").ObjectID,i=function(t){return new o(t)},r=function(t){return void 0!==t._id&&(t.id=t._id.toString()),delete t._id,delete t.__IS_ENABLED,delete t.__RANDOM_KEY,t},n=function(t){EACH(t,function(o,i){o===TO_DELETE?REMOVE({data:t,name:i}):(CHECK_IS_DATA(o)===!0||CHECK_IS_ARRAY(o)===!0)&&n(o)})},e=function(t){var o=function(t){void 0!==t.id&&(CHECK_IS_DATA(t.id)===!0?(EACH(t.id,function(o,r){CHECK_IS_DATA(o)===!0||CHECK_IS_ARRAY(o)===!0?EACH(o,function(t,r){o[r]=i(t)}):t.id[r]=i(o)}),t._id=t.id):t._id=i(id),delete t.id),t.__IS_ENABLED=!0,EACH(t,function(o,i){void 0===o&&delete t[i]})};void 0!==t.$and?EACH(t.$and,function(t){o(t)}):void 0!==t.$or?EACH(t.$or,function(t){o(t)}):o(t)};t.DB=CLASS({init:function(o,a,c){var d,s,E,u,_,f,l,v=[],C=[],A=[],D=[],O=[],m=[],T=[];a.create=d=function(t,o){v.push({data:t,callbackOrHandlers:o})},a.get=s=function(t,o){C.push({idOrParams:t,callbackOrHandlers:o})},a.update=E=function(t,o){A.push({data:t,callbackOrHandlers:o})},a.remove=u=function(t,o){D.push({id:t,callbackOrHandlers:o})},a.find=_=function(t,o){O.push({params:t,callbackOrHandlers:o})},a.count=f=function(t,o){m.push({filter:t,callbackOrHandlers:o})},a.checkIsExists=l=function(t,o){T.push({filter:t,callbackOrHandlers:o})},CONNECT_TO_DB_SERVER.addInitDBFunc(function(o){var g,S=o.collection(t.boxName+"."+c),h=o.collection(t.boxName+"."+c+"__BACKUP"),H=o.collection(t.boxName+"."+c+"__ERROR"),N=function(o){var i=o.method,r=o.data,n=new Date,e={method:i,time:n,data:r};h.insert(e,{w:0}),NODE_CONFIG.isDBLogMode===!0&&console.log("[UPPERCASE.IO-DB] `"+t.boxName+"."+c+"` DATA SAVED:",e)},I=function(o,i){o.time=new Date,H.insert(o,{w:0}),void 0!==i?i(o.errorMsg):console.log("[UPPERCASE.IO-DB] `"+t.boxName+"."+c+"` ERROR:",o)};a.create=d=function(t,o){var i,e;try{t.__IS_ENABLED=!0,t.__RANDOM_KEY=Math.random(),t.createTime=new Date,n(t),void 0!==o&&(CHECK_IS_DATA(o)!==!0?i=o:(i=o.success,e=o.error)),S.insert(t,{safe:!0},function(o,n){var a;o===TO_DELETE?(a=n[0],N({method:"create",data:a}),r(a),void 0!==i&&i(a)):I({method:"create",data:t,errorMsg:o.toString()},e)})}catch(a){I({method:"create",data:t,errorMsg:a.toString()},e)}},g=function(t,o){var i,n,a,c=t.filter,d=t.sort;try{e(c),CHECK_IS_DATA(o)!==!0?i=o:(i=o.success,n=o.notExists,a=o.error),S.find(c).sort(d).limit(1).toArray(function(o,e){var c;o===TO_DELETE?e!==TO_DELETE&&e.length>0?(c=e[0],r(c),i(c)):void 0!==n&&n():I({method:"get",params:t,errorMsg:o.toString()},a)})}catch(s){I({method:"get",params:t,errorMsg:s.toString()},a)}},a.get=s=function(t,o){var r,n,e,a,c,d,s;void 0===o&&(o=t,t=void 0),CHECK_IS_DATA(o)!==!0?a=o:(a=o.success,c=o.notExists,d=o.error);try{CHECK_IS_DATA(t)===!0?(r=t.filter,n=t.sort,e=t.isRandom):void 0!==t&&(r={_id:i(t)}),void 0===r&&(r={}),void 0===n&&(n={createTime:-1}),e===!0?(r.__RANDOM_KEY={$gte:s=Math.random()},n.__RANDOM_KEY=1,g({filter:r,sort:n},{error:d,notExists:function(){r.__RANDOM_KEY={$lte:s},g({filter:r,sort:n},o)},success:a})):g({filter:r,sort:n},o)}catch(E){I({method:"get",idOrParams:t,errorMsg:E.toString()},d)}},a.update=E=function(t,o){var n,e,a,c,d,E=t.id,u=t.$inc;try{e={_id:i(E),__IS_ENABLED:!0},void 0!==o&&(CHECK_IS_DATA(o)!==!0?a=o:(a=o.success,c=o.notExists,d=o.error)),EACH(t,function(o,i){"id"===i||"_id"===i||"__IS_ENABLED"===i||"createTime"===i||"$inc"===i?delete t[i]:o===TO_DELETE&&(void 0===n&&(n={}),n[i]="",delete t[i])}),t.lastUpdateTime=new Date,S.update(e,void 0===n?void 0===u?{$set:t}:{$set:t,$inc:u}:void 0===u?{$set:t,$unset:n}:{$set:t,$unset:n,$inc:u},{safe:!0},function(o,i){0===i?void 0!==c&&c():o===TO_DELETE?s({filter:e},{error:function(o){I({method:"update",data:t,errorMsg:o},d)},notExists:function(){void 0!==c&&c()},success:function(o){CHECK_IS_EMPTY_DATA(t)!==!0&&N({method:"update",data:o}),r(o),void 0!==a&&a(o)}}):I({method:"update",data:t,errorMsg:o.toString()},d)})}catch(_){I({method:"update",data:t,errorMsg:_.toString()},d)}},a.remove=u=function(t,o){var n,e,a,c;try{n={_id:i(t),__IS_ENABLED:!0},void 0!==o&&(CHECK_IS_DATA(o)!==!0?e=o:(e=o.success,a=o.notExists,c=o.error)),s({filter:n},{error:function(o){I({method:"remove",id:t,errorMsg:o},c)},notExists:function(){void 0!==a&&a()},success:function(o){S.update(n,{$set:{__IS_ENABLED:!1,removeTime:new Date}},{safe:!0},function(i,n){0===n?void 0!==a&&a():i===TO_DELETE?(N({method:"remove",data:o}),r(o),void 0!==e&&e(o)):I({method:"remove",id:t,errorMsg:i.toString()},c)})}})}catch(d){I({method:"remove",id:t,errorMsg:d.toString()},c)}},a.find=_=function(t,o){var i,n,a,c,d,s,E,u;try{void 0===o&&(o=t,t=void 0),void 0!==t&&(i=t.filter,n=t.sort,a=INTEGER(t.start),c=INTEGER(t.count),d=t.isFindAll),CHECK_IS_DATA(o)!==!0?s=o:(s=o.success,E=o.error),void 0===i&&(i={}),void 0===n&&(n={createTime:-1}),void 0===a&&(a=0),d!==!0&&(void 0===c||c>NODE_CONFIG.maxDataCount||isNaN(c)===!0?c=NODE_CONFIG.maxDataCount:1>c&&(c=1)),e(i),u=function(o,i){o===TO_DELETE?(i!==TO_DELETE&&EACH(i,function(t){r(t)}),s(i)):I({method:"find",params:t,errorMsg:o.toString()},E)},d===!0?S.find(i).sort(n).skip(a).toArray(u):S.find(i).sort(n).skip(a).limit(c).toArray(u)}catch(_){I({method:"find",params:t,errorMsg:_.toString()},E)}},a.count=f=function(t,o){var i,r;try{void 0===o&&(o=t,t=void 0),void 0===t&&(t={}),CHECK_IS_DATA(o)!==!0?i=o:(i=o.success,r=o.error),e(t),S.find(t).count(function(o,n){o===TO_DELETE?i(n):I({method:"count",filter:t,errorMsg:o.toString()},r)})}catch(n){I({method:"count",filter:t,errorMsg:n.toString()},r)}},a.checkIsExists=l=function(t,o){var r,n;try{void 0===o&&(o=t,t=void 0),void 0===t?t={}:CHECK_IS_DATA(t)!==!0&&(t={_id:i(t)}),CHECK_IS_DATA(o)!==!0?r=o:(r=o.success,n=o.error),e(t),S.find(t).count(function(o,i){o===TO_DELETE?r(void 0!==i&&i>0):I({method:"checkIsExists",filter:t,errorMsg:o.toString()},n)})}catch(a){I({method:"checkIsExists",filter:t,errorMsg:a.toString()},n)}},EACH(v,function(t){d(t.data,t.callbackOrHandlers)}),v=void 0,EACH(C,function(t){s(t.idOrParams,t.callbackOrHandlers)}),C=void 0,EACH(A,function(t){E(t.data,t.callbackOrHandlers)}),A=void 0,EACH(D,function(t){u(t.id,t.callbackOrHandlers)}),D=void 0,EACH(O,function(t){_(t.params,t.callbackOrHandlers)}),O=void 0,EACH(m,function(t){f(t.filter,t.callbackOrHandlers)}),m=void 0,EACH(T,function(t){l(t.filter,t.callbackOrHandlers)}),T=void 0})}})}),FOR_BOX(function(t){"use strict";t.LOG_DB=CLASS({init:function(o,i,r){var n,e=[];i.log=n=function(t){e.push(t)},CONNECT_TO_DB_SERVER.addInitDBFunc(function(o){var a=o.collection(t.boxName+"."+r);i.log=n=function(t){t.time=new Date,a.insert(t,{w:0})},EACH(e,function(t){n(t)}),e=void 0})}})}),OVERRIDE(NODE_CONFIG,function(t){global.NODE_CONFIG=NODE_CONFIG=COMBINE([t,{isDBLogMode:!1,maxDataCount:1e3}])});