global.CONNECT_TO_DB_SERVER=CONNECT_TO_DB_SERVER=METHOD(function(o){var t,e,i=[];return o.addInitDBFunc=e=function(o){void 0===t?i.push(o):o(t)},{run:function(o,e){"use strict";var r=o.username,n=o.password,d=void 0===o.host?"127.0.0.1":o.host,a=void 0===o.port?27017:o.port,c=o.name;require("mongodb").MongoClient.connect("mongodb://"+(void 0!==r&&void 0!==n?r+":"+n+"@":"")+d+":"+a+"/"+c,function(o,r){o!==TO_DELETE?console.log(CONSOLE_RED("[UPPERCASE.IO-DB] CONNECT TO DB SERVER FAILED: "+o.toString())):(t=r,EACH(i,function(o){o(t)}),i=void 0,void 0!==e&&e())})}}}),FOR_BOX(function(o){"use strict";var t=require("mongodb").ObjectID,e=function(o){return new t(o)},i=function(o){return void 0!==o._id&&(o.id=o._id.toString()),delete o._id,delete o.__IS_ENABLED,delete o.__RANDOM_KEY,o},r=function(o){EACH(o,function(t,e){t===TO_DELETE?REMOVE({data:o,name:e}):(CHECK_IS_DATA(t)===!0||CHECK_IS_ARRAY(t)===!0)&&r(t)})},n=function(o,t){var i=function(o){void 0!==o.id&&(CHECK_IS_DATA(o.id)===!0?(EACH(o.id,function(t,i){CHECK_IS_DATA(t)===!0||CHECK_IS_ARRAY(t)===!0?EACH(t,function(o,i){t[i]=e(o)}):o.id[i]=e(t)}),o._id=o.id):o._id=e(id),delete o.id),t!==!0&&(o.__IS_ENABLED=!0),EACH(o,function(t,e){void 0===t&&delete o[e]})};void 0!==o.$and?EACH(o.$and,function(o){i(o)}):void 0!==o.$or?EACH(o.$or,function(o){i(o)}):i(o)};o.DB=CLASS({init:function(t,d,a){var c,E,s,u,_,l,O,f=[],v=[],C=[],m=[],A=[],D=[],T=[];d.create=c=function(o,t){f.push({data:o,callbackOrHandlers:t})},d.get=E=function(o,t){v.push({idOrParams:o,callbackOrHandlers:t})},d.update=s=function(o,t){C.push({data:o,callbackOrHandlers:t})},d.remove=u=function(o,t){m.push({idOrParams:o,callbackOrHandlers:t})},d.find=_=function(o,t){A.push({params:o,callbackOrHandlers:t})},d.count=l=function(o,t){D.push({filterOrParams:o,callbackOrHandlers:t})},d.checkIsExists=O=function(o,t){T.push({filterOrParams:o,callbackOrHandlers:t})},CONNECT_TO_DB_SERVER.addInitDBFunc(function(t){var S,I=t.collection(o.boxName+"."+a),g=t.collection(o.boxName+"."+a+"__HISTORY"),N=t.collection(o.boxName+"."+a+"__ERROR"),H=function(t,e,i,r){g.findOne({id:e},function(o,n){var d;o===TO_DELETE&&(d={method:t,change:i,time:r},n===TO_DELETE?g.insert({id:e,timeline:[d]},{w:0}):g.update({id:e},{$push:{timeline:d}},{w:0}))}),NODE_CONFIG.isDBLogMode===!0&&console.log("[UPPERCASE.IO-DB] `"+o.boxName+"."+a+"` DATA SAVED:",data)},R=function(t,e){t.time=new Date,N.insert(t,{w:0}),void 0!==e?e(t.errorMsg):console.log("[UPPERCASE.IO-DB] `"+o.boxName+"."+a+"` ERROR:",t)};d.create=c=function(o,t){var e,n;try{o.__IS_ENABLED=!0,o.__RANDOM_KEY=Math.random(),o.createTime=new Date,r(o),void 0!==t&&(CHECK_IS_DATA(t)!==!0?e=t:(e=t.success,n=t.error)),I.insert(o,{safe:!0},function(t,r){var d;t===TO_DELETE?(d=r[0],H("create",d._id.toString(),o,o.createTime),i(d),void 0!==e&&e(d)):R({method:"create",data:o,errorMsg:t.toString()},n)})}catch(d){R({method:"create",data:o,errorMsg:d.toString()},n)}},S=function(t,e){var r,d,c,E=t.filter,s=t.sort,u=t.isIncludeRemoved;try{n(E,u),CHECK_IS_DATA(e)!==!0?r=e:(r=e.success,d=e.notExists,c=e.error),I.find(E).sort(s).limit(1).toArray(function(e,n){var s;e===TO_DELETE?n!==TO_DELETE&&n.length>0?(s=n[0],i(s),r(s)):void 0!==d?d():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+o.boxName+"."+a+".get` NOT EXISTS."),E):R({method:"get",params:t,errorMsg:e.toString()},c)})}catch(_){R({method:"get",params:t,errorMsg:_.toString()},c)}},d.get=E=function(o,t){var i,r,n,d,a,c,E,s,u;void 0===t&&(t=o,o=void 0),CHECK_IS_DATA(t)!==!0?c=t:(c=t.success,E=t.notExists,s=t.error);try{CHECK_IS_DATA(o)===!0?(i=o.id,r=o.filter,n=o.sort,d=o.isRandom,a=o.isIncludeRemoved):void 0!==o&&(i=o),void 0===r&&(r={},void 0!==i&&(r._id=e(i))),void 0===n&&(n={createTime:-1}),d===!0?(r.__RANDOM_KEY={$gte:u=Math.random()},n.__RANDOM_KEY=1,S({filter:r,sort:n,isIncludeRemoved:a},{error:s,notExists:function(){r.__RANDOM_KEY={$lte:u},S({filter:r,sort:n,isIncludeRemoved:a},t)},success:c})):S({filter:r,sort:n,isIncludeRemoved:a},t)}catch(_){R({method:"get",idOrParams:o,errorMsg:_.toString()},s)}},d.update=s=function(t,r){var n,d,c,s,u,_,l,O=t.id,f=t.$inc;try{d={_id:e(O),__IS_ENABLED:!0},void 0!==r&&(CHECK_IS_DATA(r)!==!0?c=r:(c=r.success,s=r.notExists,u=r.error)),EACH(t,function(o,e){"id"===e||"_id"===e||"__IS_ENABLED"===e||"createTime"===e||"$inc"===e?delete t[e]:o===TO_DELETE?(void 0===n&&(n={}),n[e]="",delete t[e]):l=!0}),t.lastUpdateTime=new Date,_={$set:t},void 0!==n&&(_.$unset=n),void 0!==f&&(_.$inc=f),I.update(d,_,{safe:!0},function(e,r){0===r?void 0!==s?s():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+o.boxName+"."+a+".update` NOT EXISTS."),d):e===TO_DELETE?E({filter:d},{error:function(o){R({method:"update",data:t,errorMsg:o},u)},notExists:function(){void 0!==s?s():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+o.boxName+"."+a+".update` NOT EXISTS."),d)},success:function(o){var e;(void 0===f||l===!0||void 0!==n)&&(e={},l===!0&&EACH(t,function(o,t){e[t]=o}),void 0!==n&&EACH(n,function(o,t){e[t]=TO_DELETE}),H("update",O,e,t.lastUpdateTime)),i(o),void 0!==c&&c(o)}}):R({method:"update",data:t,errorMsg:e.toString()},u)})}catch(v){R({method:"update",data:t,errorMsg:v.toString()},u)}},d.remove=u=function(t,r){var n,d,c,s,u,_;try{CHECK_IS_DATA(t)!==!0?n=t:(n=t.id,d=t.isRemoveForever),c={_id:e(n),__IS_ENABLED:!0},void 0!==r&&(CHECK_IS_DATA(r)!==!0?s=r:(s=r.success,u=r.notExists,_=r.error)),E({filter:c},{error:function(o){R({method:"remove",id:n,errorMsg:o},_)},notExists:function(){void 0!==u?u():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+o.boxName+"."+a+".remove` NOT EXISTS."),c)},success:function(t){var e;I.update(c,{$set:e={__IS_ENABLED:!1,removeTime:new Date}},{safe:!0},function(r,d){0===d?void 0!==u?u():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+o.boxName+"."+a+".remove` NOT EXISTS."),c):r===TO_DELETE?(H("remove",t.id,e,e.removeTime),i(t),void 0!==s&&s(t)):R({method:"remove",id:n,errorMsg:r.toString()},_)})}})}catch(l){R({method:"remove",id:n,errorMsg:l.toString()},_)}},d.find=_=function(o,t){var e,r,d,a,c,E,s,u,_;try{void 0===t&&(t=o,o=void 0),void 0!==o&&(e=o.filter,r=o.sort,d=INTEGER(o.start),a=INTEGER(o.count),c=o.isFindAll,E=o.isIncludeRemoved),CHECK_IS_DATA(t)!==!0?s=t:(s=t.success,u=t.error),void 0===e&&(e={}),void 0===r&&(r={createTime:-1}),void 0===d&&(d=0),c!==!0&&(void 0===a||a>NODE_CONFIG.maxDataCount||isNaN(a)===!0?a=NODE_CONFIG.maxDataCount:1>a&&(a=1)),n(e),_=function(t,e){t===TO_DELETE?(e!==TO_DELETE&&EACH(e,function(o){i(o)}),s(e)):R({method:"find",params:o,errorMsg:t.toString()},u)},c===!0?I.find(e).sort(r).skip(d).toArray(_):I.find(e).sort(r).skip(d).limit(a).toArray(_)}catch(l){R({method:"find",params:o,errorMsg:l.toString()},u)}},d.count=l=function(o,t){var e,i,r,d;try{CHECK_IS_DATA(o)!==!0?e=o:(e=o.filter,i=o.isIncludeRemoved),void 0===t&&(t=e,e=void 0),void 0===e&&(e={}),CHECK_IS_DATA(t)!==!0?r=t:(r=t.success,d=t.error),n(e),I.find(e).count(function(o,t){o===TO_DELETE?r(t):R({method:"count",filter:e,errorMsg:o.toString()},d)})}catch(a){R({method:"count",filter:e,errorMsg:a.toString()},d)}},d.checkIsExists=O=function(o,t){var i,r,d,a;try{CHECK_IS_DATA(o)!==!0?i=o:(i=o.filter,r=o.isIncludeRemoved),void 0===t&&(t=i,i=void 0),void 0===i?i={}:CHECK_IS_DATA(i)!==!0&&(i={_id:e(i)}),CHECK_IS_DATA(t)!==!0?d=t:(d=t.success,a=t.error),n(i),I.find(i).count(function(o,t){o===TO_DELETE?d(void 0!==t&&t>0):R({method:"checkIsExists",filter:i,errorMsg:o.toString()},a)})}catch(c){R({method:"checkIsExists",filter:i,errorMsg:c.toString()},a)}},EACH(f,function(o){c(o.data,o.callbackOrHandlers)}),f=void 0,EACH(v,function(o){E(o.idOrParams,o.callbackOrHandlers)}),v=void 0,EACH(C,function(o){s(o.data,o.callbackOrHandlers)}),C=void 0,EACH(m,function(o){u(o.idOrParams,o.callbackOrHandlers)}),m=void 0,EACH(A,function(o){_(o.params,o.callbackOrHandlers)}),A=void 0,EACH(D,function(o){l(o.filterOrParams,o.callbackOrHandlers)}),D=void 0,EACH(T,function(o){O(o.filterOrParams,o.callbackOrHandlers)}),T=void 0})}})}),FOR_BOX(function(o){"use strict";o.LOG_DB=CLASS({init:function(t,e,i){var r,n=[];e.log=r=function(o){n.push(o)},CONNECT_TO_DB_SERVER.addInitDBFunc(function(t){var d=t.collection(o.boxName+"."+i);e.log=r=function(o){o.time=new Date,d.insert(o,{w:0})},EACH(n,function(o){r(o)}),n=void 0})}})}),OVERRIDE(NODE_CONFIG,function(o){global.NODE_CONFIG=NODE_CONFIG=COMBINE([o,{isDBLogMode:!1,maxDataCount:1e3}])});