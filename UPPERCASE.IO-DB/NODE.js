global.CONNECT_TO_DB_SERVER=CONNECT_TO_DB_SERVER=METHOD(function(o){var n,E,i=[];return o.addInitDBFunc=E=function(o){void 0===n?i.push(o):o(n)},{run:function(o,E){"use strict";var t=o.username,r=o.password,d=void 0===o.host?"127.0.0.1":o.host,u=void 0===o.port?27017:o.port,O=o.name;require("mongodb").MongoClient.connect("mongodb://"+(void 0!==t&&void 0!==r?t+":"+r+"@":"")+d+":"+u+"/"+O,function(o,t){o!==TO_DELETE?console.log(CONSOLE_RED("[UPPERCASE.IO-DB] CONNECT TO DB SERVER FAILED: "+o.toString())):(n=t,EACH(i,function(o){o(n)}),i=void 0,void 0!==E&&E())})}}});FOR_BOX(function(e){"use strict";var o=require("mongodb").ObjectID;e.DB=CLASS({init:function(t,i,r){var n,d,a,c,s,E,u,_,l,v=[],m=[],f=[],O=[],A=[],C=[],T=[],S=function(e){return d===!0?e:new o(e)},D=function(e){return void 0!==e._id&&(e.id=e._id.toString()),delete e._id,delete e.__IS_ENABLED,delete e.__RANDOM_KEY,e},I=function(e){EACH(e,function(o,t){void 0===o||o===TO_DELETE?REMOVE({data:e,name:t}):(CHECK_IS_DATA(o)===!0||CHECK_IS_ARRAY(o)===!0)&&I(o)})},g=function(e,o){var t=function(e){void 0!==e.id&&(CHECK_IS_DATA(e.id)===!0?(EACH(e.id,function(o,t){CHECK_IS_DATA(o)===!0||CHECK_IS_ARRAY(o)===!0?EACH(o,function(e,t){o[t]=S(e)}):e.id[t]=S(o)}),e._id=e.id):e._id=S(e.id),delete e.id),o!==!0&&(e.__IS_ENABLED=!0),EACH(e,function(o,t){void 0===o&&delete e[t]})};void 0!==e.$and?EACH(e.$and,function(e){t(e)}):void 0!==e.$or?EACH(e.$or,function(e){t(e)}):t(e)};CHECK_IS_DATA(r)!==!0?n=r:(n=r.name,d=r.isNotUsingObjectId),i.create=a=function(e,o){v.push({data:e,callbackOrHandlers:o})},i.get=c=function(e,o){m.push({idOrParams:e,callbackOrHandlers:o})},i.update=s=function(e,o){f.push({data:e,callbackOrHandlers:o})},d!==!0&&(i.remove=E=function(e,o){O.push({id:e,callbackOrHandlers:o})}),i.find=u=function(e,o){A.push({params:e,callbackOrHandlers:o})},i.count=_=function(e,o){C.push({params:e,callbackOrHandlers:o})},i.checkIsExists=l=function(e,o){T.push({params:e,callbackOrHandlers:o})},CONNECT_TO_DB_SERVER.addInitDBFunc(function(o){var t,r=o.collection(e.boxName+"."+n),H=o.collection(e.boxName+"."+n+"__HISTORY"),N=o.collection(e.boxName+"."+n+"__ERROR"),h=function(o,t,i,r){H.findOne({id:t},function(e,n){var d;e===TO_DELETE&&(d={method:o,change:i,time:r},n===TO_DELETE?H.insert({id:t,timeline:[d]},{w:0}):H.update({id:t},{$push:{timeline:d}},{w:0}))}),NODE_CONFIG.isDBLogMode===!0&&console.log("[UPPERCASE.IO-DB] `"+e.boxName+"."+n+"` DATA SAVED:",i)},L=function(o,t){o.time=new Date,N.insert(o,{w:0}),void 0!==t?t(o.errorMsg):console.log("[UPPERCASE.IO-DB] `"+e.boxName+"."+n+"` ERROR:",o)};i.create=a=function(e,o){var t,i;try{e.__IS_ENABLED=!0,e.__RANDOM_KEY=Math.random(),e.createTime=new Date,I(e),delete e._id,d===!0&&(e._id=e.id),delete e.id,void 0!==o&&(CHECK_IS_DATA(o)!==!0?t=o:(t=o.success,i=o.error)),r.insert(e,{safe:!0},function(o,r){var n;o===TO_DELETE?(n=r[0],D(n),h("create",n.id,n,n.createTime),void 0!==t&&t(n)):L({method:"create",data:e,errorMsg:o.toString()},i)})}catch(n){L({method:"create",data:e,errorMsg:n.toString()},i)}},t=function(o,t){var i,d,a,c=o.filter,s=o.sort,E=o.isIncludeRemoved;try{g(c,E),CHECK_IS_DATA(t)!==!0?i=t:(i=t.success,d=t.notExists,a=t.error),r.find(c).sort(s).limit(1).toArray(function(t,r){var s;t===TO_DELETE?r!==TO_DELETE&&r.length>0?(s=r[0],D(s),i(s)):void 0!==d?d():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+e.boxName+"."+n+".get` NOT EXISTS."),c):L({method:"get",params:o,errorMsg:t.toString()},a)})}catch(u){L({method:"get",params:o,errorMsg:u.toString()},a)}},i.get=c=function(e,o){var i,r,n,d,a,c,s,E,u;try{CHECK_IS_DATA(e)!==!0?i=e:(i=e.id,r=e.filter,n=e.sort,d=e.isRandom,a=e.isIncludeRemoved),CHECK_IS_DATA(o)!==!0?c=o:(c=o.success,s=o.notExists,E=o.error),void 0===n&&(n={createTime:-1}),d===!0?(void 0===r&&(r={}),r.__RANDOM_KEY={$gte:u=Math.random()},n.__RANDOM_KEY=1,t({filter:r,sort:n,isIncludeRemoved:a},{error:E,notExists:function(){r.__RANDOM_KEY={$lte:u},t({filter:r,sort:n,isIncludeRemoved:a},o)},success:c})):(void 0===r&&(r={_id:S(i)}),t({filter:r,sort:n,isIncludeRemoved:a},o))}catch(_){L({method:"get",idOrParams:e,errorMsg:_.toString()},E)}},i.update=s=function(o,t){var i,d,a,s,E,u,_,l=o.id,v=o.$inc;try{d={_id:S(l),__IS_ENABLED:!0},void 0!==t&&(CHECK_IS_DATA(t)!==!0?a=t:(a=t.success,s=t.notExists,E=t.error)),EACH(o,function(e,t){"id"===t||"_id"===t||"__IS_ENABLED"===t||"createTime"===t||"$inc"===t?delete o[t]:e===TO_DELETE?(void 0===i&&(i={}),i[t]=""):_=!0}),o.lastUpdateTime=new Date,I(o),u={$set:o},void 0!==i&&(u.$unset=i),void 0!==v&&(u.$inc=v),r.update(d,u,{safe:!0},function(t,r){0===r?void 0!==s?s():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+e.boxName+"."+n+".update` NOT EXISTS."),d):t===TO_DELETE?c({filter:d},{error:function(e){L({method:"update",data:o,errorMsg:e},E)},notExists:function(){void 0!==s?s():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+e.boxName+"."+n+".update` NOT EXISTS."),d)},success:function(e){var t;(void 0===v||_===!0||void 0!==i)&&(t={},_===!0&&EACH(o,function(e,o){t[o]=e}),void 0!==i&&EACH(i,function(e,o){t[o]=TO_DELETE}),h("update",l,t,e.lastUpdateTime)),D(e),void 0!==a&&a(e)}}):L({method:"update",data:o,errorMsg:t.toString()},E)})}catch(m){L({method:"update",data:o,errorMsg:m.toString()},E)}},d!==!0&&(i.remove=E=function(o,t){var i,d,a,s;try{i={_id:S(o),__IS_ENABLED:!0},void 0!==t&&(CHECK_IS_DATA(t)!==!0?d=t:(d=t.success,a=t.notExists,s=t.error)),c({filter:i},{error:function(e){L({method:"remove",id:o,errorMsg:e},s)},notExists:function(){void 0!==a?a():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+e.boxName+"."+n+".remove` NOT EXISTS."),i)},success:function(t){var c;r.update(i,{$set:c={__IS_ENABLED:!1,removeTime:new Date}},{safe:!0},function(r,E){0===E?void 0!==a?a():console.log(CONSOLE_YELLOW("[UPPERCASE.IO-DB] `"+e.boxName+"."+n+".remove` NOT EXISTS."),i):r===TO_DELETE?(h("remove",t.id,{removeTime:c.removeTime},c.removeTime),D(t),void 0!==d&&d(t)):L({method:"remove",id:o,errorMsg:r.toString()},s)})}})}catch(E){L({method:"remove",id:o,errorMsg:E.toString()},s)}}),i.find=u=function(e,o){var t,i,n,d,a,c,s,E,u;try{void 0===o&&(o=e,e=void 0),void 0!==e&&(t=e.filter,i=e.sort,n=INTEGER(e.start),d=INTEGER(e.count),a=e.isFindAll,c=e.isIncludeRemoved),CHECK_IS_DATA(o)!==!0?s=o:(s=o.success,E=o.error),void 0===t&&(t={}),void 0===i&&(i={createTime:-1}),void 0===n&&(n=0),a!==!0&&(void 0===d||d>NODE_CONFIG.maxDataCount||isNaN(d)===!0?d=NODE_CONFIG.maxDataCount:1>d&&(d=1)),g(t),u=function(o,t){o===TO_DELETE?(t!==TO_DELETE&&EACH(t,function(e){D(e)}),s(t)):L({method:"find",params:e,errorMsg:o.toString()},E)},a===!0?r.find(t).sort(i).skip(n).toArray(u):r.find(t).sort(i).skip(n).limit(d).toArray(u)}catch(_){L({method:"find",params:e,errorMsg:_.toString()},E)}},i.count=_=function(e,o){var t,i,n,d;try{void 0===o&&(o=e,e=void 0),void 0!==e&&(t=e.filter,i=e.isIncludeRemoved),void 0===o&&(o=t,t=void 0),void 0===t&&(t={}),CHECK_IS_DATA(o)!==!0?n=o:(n=o.success,d=o.error),g(t),r.find(t).count(function(e,o){e===TO_DELETE?n(o):L({method:"count",filter:t,errorMsg:e.toString()},d)})}catch(a){L({method:"count",filter:t,errorMsg:a.toString()},d)}},i.checkIsExists=l=function(e,o){var t,i,n,d;try{void 0===o&&(o=e,e=void 0),void 0!==e&&(t=e.filter,i=e.isIncludeRemoved),void 0===o&&(o=t,t=void 0),void 0===t?t={}:CHECK_IS_DATA(t)!==!0&&(t={_id:S(t)}),CHECK_IS_DATA(o)!==!0?n=o:(n=o.success,d=o.error),g(t),r.find(t).count(function(e,o){e===TO_DELETE?n(void 0!==o&&o>0):L({method:"checkIsExists",filter:t,errorMsg:e.toString()},d)})}catch(a){L({method:"checkIsExists",filter:t,errorMsg:a.toString()},d)}},EACH(v,function(e){a(e.data,e.callbackOrHandlers)}),v=void 0,EACH(m,function(e){c(e.idOrParams,e.callbackOrHandlers)}),m=void 0,EACH(f,function(e){s(e.data,e.callbackOrHandlers)}),f=void 0,EACH(O,function(e){E(e.id,e.callbackOrHandlers)}),O=void 0,EACH(A,function(e){u(e.params,e.callbackOrHandlers)}),A=void 0,EACH(C,function(e){_(e.params,e.callbackOrHandlers)}),C=void 0,EACH(T,function(e){l(e.params,e.callbackOrHandlers)}),T=void 0})}})});FOR_BOX(function(n){"use strict";n.LOG_DB=CLASS({init:function(i,t,o){var c,u=[];t.log=c=function(n){u.push(n)},CONNECT_TO_DB_SERVER.addInitDBFunc(function(i){var e=i.collection(n.boxName+"."+o);t.log=c=function(n){n.time=new Date,e.insert(n,{w:0})},EACH(u,function(n){c(n)}),u=void 0})}})});OVERRIDE(NODE_CONFIG,function(O){global.NODE_CONFIG=NODE_CONFIG=COMBINE([O,{isDBLogMode:!1,maxDataCount:1e3}])});